{% extends "base.html" %}

{% block title %}Comprehensive Portfolio Analysis{% endblock %}

{% block content %}
<!-- Header -->
<div class="gradient-bg rounded-2xl p-8 mb-8 text-white">
    <h1 class="text-4xl font-bold mb-4">Institutional-Grade Portfolio Analytics</h1>
    <p class="text-lg opacity-90">
        Quantitative risk analysis with Monte Carlo simulation, distribution fitting, 
        factor decomposition, and extreme value theory.
    </p>
</div>

<!-- Input Section -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Portfolio Configuration</h2>
        <button onclick="loadExample()" class="text-primary-600 hover:text-primary-700 font-medium">
            <i class="fas fa-magic mr-1"></i>Load Example Portfolio
        </button>
    </div>
    
    <form id="analysis-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Holdings (Ticker:Weight)</label>
                <textarea id="holdings-input" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm"
                    placeholder="AAPL:0.15, MSFT:0.15, GOOGL:0.15, AMZN:0.15, BRK.B:0.30, LLY:0.07, KO:0.03"></textarea>
                <p class="text-xs text-gray-500 mt-1">Sectors auto-detected from Yahoo Finance</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Analysis Period</label>
                <select id="period" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="1y">1 Year</option>
                    <option value="2y" selected>2 Years</option>
                    <option value="5y">5 Years</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Portfolio Value</label>
                <input type="number" id="portfolio-value" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="100000" step="1000">
            </div>
        </div>
        
        <button type="submit" class="bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition">
            <i class="fas fa-chart-line mr-2"></i>Run Comprehensive Analysis
        </button>
    </form>
</div>

<!-- Loading State -->
<div id="loading-state" class="hidden">
    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
        <div class="relative w-24 h-24 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-primary-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-primary-600 rounded-full border-t-transparent animate-spin"></div>
            <i class="fas fa-chart-area absolute inset-0 flex items-center justify-center text-3xl text-primary-600"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Running Quantitative Analysis</h3>
        <p class="text-gray-600">Fitting distributions, running Monte Carlo simulations, calculating risk metrics...</p>
    </div>
</div>

<!-- Results Section -->
<div id="results-section" class="hidden space-y-6">
    
    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div class="bg-white rounded-xl p-4 card-shadow text-center">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Ann. Return</p>
            <p id="metric-return" class="text-xl font-bold text-green-600 mt-1">--</p>
            <p id="ci-return" class="text-xs text-gray-400">95% CI: --</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Volatility</p>
            <p id="metric-vol" class="text-xl font-bold text-orange-600 mt-1">--</p>
            <p id="ci-vol" class="text-xs text-gray-400">95% CI: --</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Max Drawdown</p>
            <p id="metric-dd" class="text-xl font-bold text-red-600 mt-1">--</p>
            <p id="metric-dd-days" class="text-xs text-gray-400">-- days</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Sharpe Ratio</p>
            <p id="metric-sharpe" class="text-xl font-bold text-blue-600 mt-1">--</p>
            <p id="ci-sharpe" class="text-xs text-gray-400">95% CI: --</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Beta</p>
            <p id="metric-beta" class="text-xl font-bold text-purple-600 mt-1">--</p>
            <p class="text-xs text-gray-400">vs S&P 500</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Alpha</p>
            <p id="metric-alpha" class="text-xl font-bold text-indigo-600 mt-1">--</p>
            <p class="text-xs text-gray-400">Annualized</p>
        </div>
    </div>

    <!-- Holdings with Auto-Detected Sectors -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Portfolio Holdings (Auto-Detected Sectors)</h3>
        <div id="holdings-table" class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Ticker</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Company</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Sector</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">Weight</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">Value</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">Beta</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">Div Yield</th>
                    </tr>
                </thead>
                <tbody id="holdings-tbody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Distribution Analysis -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-bar text-primary-600 mr-2"></i>Probability Distribution Analysis
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Distribution Fitting (AIC Criteria)</h4>
                <div id="distribution-comparison" class="space-y-2">
                    <!-- Dynamic content -->
                </div>
            </div>
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Return Distribution vs Normal</h4>
                <div id="distribution-chart" class="h-64"></div>
            </div>
        </div>
        <div class="mt-4 p-4 bg-yellow-50 rounded-lg" id="normality-warning">
            <!-- Dynamic warning about non-normality -->
        </div>
    </div>

    <!-- Monte Carlo Simulation -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-dice text-primary-600 mr-2"></i>Monte Carlo Simulation (5,000 Paths, 1 Year)
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div id="monte-carlo-chart" class="h-80"></div>
            </div>
            <div class="space-y-3">
                <div class="bg-green-50 rounded-lg p-3">
                    <p class="text-xs text-green-700">Probability of Profit</p>
                    <p id="mc-profit-prob" class="text-2xl font-bold text-green-600">--</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-3">
                    <p class="text-xs text-blue-700">Probability of 10%+ Return</p>
                    <p id="mc-target-prob" class="text-2xl font-bold text-blue-600">--</p>
                </div>
                <div class="bg-red-50 rounded-lg p-3">
                    <p class="text-xs text-red-700">Expected Max Drawdown</p>
                    <p id="mc-expected-dd" class="text-2xl font-bold text-red-600">--</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-700">95% Confidence Interval (1Y)</p>
                    <p id="mc-ci" class="text-lg font-bold text-gray-900">--</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-700">Worst Case (0.5%)</p>
                    <p id="mc-worst" class="text-lg font-bold text-red-600">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistical Tests -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-flask text-primary-600 mr-2"></i>Statistical Tests (95% Confidence)
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="border rounded-lg p-4" id="test-jarque-bera">
                <p class="text-sm font-medium text-gray-700">Jarque-Bera Test</p>
                <p class="text-xs text-gray-500">Normality</p>
                <p class="text-lg font-bold mt-1" id="jb-stat">--</p>
                <p class="text-sm" id="jb-result">--</p>
            </div>
            <div class="border rounded-lg p-4" id="test-ljung-box">
                <p class="text-sm font-medium text-gray-700">Ljung-Box Test</p>
                <p class="text-xs text-gray-500">Autocorrelation</p>
                <p class="text-lg font-bold mt-1" id="lb-stat">--</p>
                <p class="text-sm" id="lb-result">--</p>
            </div>
            <div class="border rounded-lg p-4" id="test-shapiro">
                <p class="text-sm font-medium text-gray-700">Shapiro-Wilk Test</p>
                <p class="text-xs text-gray-500">Normality</p>
                <p class="text-lg font-bold mt-1" id="sw-stat">--</p>
                <p class="text-sm" id="sw-result">--</p>
            </div>
            <div class="border rounded-lg p-4" id="test-arch">
                <p class="text-sm font-medium text-gray-700">ARCH LM Test</p>
                <p class="text-xs text-gray-500">Volatility Clustering</p>
                <p class="text-lg font-bold mt-1" id="arch-stat">--</p>
                <p class="text-sm" id="arch-result">--</p>
            </div>
        </div>
    </div>

    <!-- Risk-Adjusted Metrics -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Risk-Adjusted Performance Metrics</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-xs text-gray-500">Sortino Ratio</p>
                <p id="metric-sortino" class="text-2xl font-bold text-gray-900">--</p>
                <p class="text-xs text-gray-400">Downside risk adjusted</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-xs text-gray-500">Calmar Ratio</p>
                <p id="metric-calmar" class="text-2xl font-bold text-gray-900">--</p>
                <p class="text-xs text-gray-400">Return / Max DD</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-xs text-gray-500">Omega Ratio</p>
                <p id="metric-omega" class="text-2xl font-bold text-gray-900">--</p>
                <p class="text-xs text-gray-400">Gain/Loss asymmetry</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-xs text-gray-500">Information Ratio</p>
                <p id="metric-info" class="text-2xl font-bold text-gray-900">--</p>
                <p class="text-xs text-gray-400">vs Benchmark</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-xs text-gray-500">Treynor Ratio</p>
                <p id="metric-treynor" class="text-2xl font-bold text-gray-900">--</p>
                <p class="text-xs text-gray-400">Systematic risk adj.</p>
            </div>
        </div>
    </div>

    <!-- VaR and Tail Risk -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Value at Risk (VaR)</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                    <div>
                        <p class="text-sm text-red-700">Parametric VaR (95%)</p>
                        <p class="text-xs text-red-500">Normal distribution</p>
                    </div>
                    <p id="var-param-95" class="text-xl font-bold text-red-600">--</p>
                </div>
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                    <div>
                        <p class="text-sm text-red-700">Historical VaR (95%)</p>
                        <p class="text-xs text-red-500">Empirical percentile</p>
                    </div>
                    <p id="var-hist-95" class="text-xl font-bold text-red-600">--</p>
                </div>
                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                    <div>
                        <p class="text-sm text-orange-700">CVaR / ES (95%)</p>
                        <p class="text-xs text-orange-500">Expected Shortfall</p>
                    </div>
                    <p id="cvar-95" class="text-xl font-bold text-orange-600">--</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Extreme Value Theory</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-700">Tail Index (Hill Estimator)</p>
                    <p id="hill-estimator" class="text-xl font-bold text-gray-900">--</p>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-700">GPD Shape (ξ)</p>
                    <p id="gpd-xi" class="text-xl font-bold text-gray-900">--</p>
                </div>
                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                    <p class="text-sm text-purple-700">Black Swan Probability</p>
                    <p id="black-swan-prob" class="text-xl font-bold text-purple-600">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Drawdown Analysis -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Drawdown Analysis</h3>
            <div id="drawdown-chart" class="h-80"></div>
        </div>
        
        <!-- Rolling Beta -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Rolling Beta (63-day)</h3>
            <div id="rolling-beta-chart" class="h-80"></div>
        </div>
    </div>

    <!-- Volatility Analysis -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-wave-square text-primary-600 mr-2"></i>Volatility Clustering (ARCH Effects)
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div>
                <div id="volatility-chart" class="h-64"></div>
            </div>
            <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Volatility of Volatility</p>
                    <p id="vol-of-vol" class="text-2xl font-bold text-gray-900">--</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Persistence</p>
                    <p id="vol-persistence" class="text-2xl font-bold text-gray-900">--</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Half-Life (days)</p>
                    <p id="vol-halflife" class="text-2xl font-bold text-gray-900">--</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4" id="arch-effect-box">
                    <p class="text-sm text-gray-500">ARCH Effects</p>
                    <p id="arch-effects" class="text-2xl font-bold">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Principal Component Analysis -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-project-diagram text-primary-600 mr-2"></i>Principal Component Analysis
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Explained Variance</h4>
                <div id="pca-variance-chart" class="h-64"></div>
            </div>
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Factor Loadings (PC1, PC2, PC3)</h4>
                <div id="pca-loadings-chart" class="h-64"></div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">Condition Number</p>
                        <p id="pca-condition" class="text-lg font-bold text-gray-900">--</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">Effective Rank</p>
                        <p id="pca-rank" class="text-lg font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rolling Statistics with Confidence Bands -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Rolling Statistics (63-day) with 95% Confidence Bands</h3>
        <div id="rolling-stats-chart" class="h-80"></div>
    </div>

    <!-- Stress Test Results -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>Stress Test Scenarios
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="stress-test-grid">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Correlation Matrix -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Asset Correlation Matrix</h3>
        <div id="correlation-heatmap" class="h-96"></div>
    </div>

    <!-- Efficient Frontier -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-scatter text-primary-600 mr-2"></i>Efficient Frontier Analysis
        </h3>
        <div id="efficient-frontier-chart" class="h-80"></div>
    </div>

    <!-- Performance Comparison -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-line text-primary-600 mr-2"></i>Performance vs Benchmarks
        </h3>
        <div id="performance-chart" class="h-80"></div>
    </div>

    <!-- Risk Contribution -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-pie text-primary-600 mr-2"></i>Risk Contribution Analysis
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div id="risk-contribution-chart" class="h-80"></div>
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Weight Concentration</p>
                    <div id="weight-concentration" class="text-sm mt-2">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Returns Heatmap -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-th text-primary-600 mr-2"></i>Monthly Returns Heatmap
        </h3>
        <div id="monthly-returns-heatmap" class="h-96"></div>
    </div>

    <!-- Performance Metrics Table -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-table text-primary-600 mr-2"></i>Performance Metrics Comparison
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm" id="performance-metrics-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Metric</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">Portfolio</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">S&P 500 (SPY)</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">MSCI World (URTH)</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">95% CI Lower</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">95% CI Upper</th>
                    </tr>
                </thead>
                <tbody id="performance-metrics-tbody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Risk Matrix Table -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-exclamation-circle text-primary-600 mr-2"></i>Risk Matrix
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm" id="risk-matrix-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Risk Factor</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">Value</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">Risk Level</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">Interpretation</th>
                    </tr>
                </thead>
                <tbody id="risk-matrix-tbody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Diversification Analysis -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Diversification Analysis</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500 mb-2">Effective N</p>
                <p id="effective-n" class="text-3xl font-bold text-primary-600">--</p>
                <p class="text-xs text-gray-400">Uncorrelated bets</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500 mb-2">Concentration (HHI)</p>
                <p id="concentration" class="text-3xl font-bold text-orange-600">--</p>
                <p class="text-xs text-gray-400">Lower is better</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500 mb-2">R-Squared</p>
                <p id="r-squared" class="text-3xl font-bold text-blue-600">--</p>
                <p class="text-xs text-gray-400">vs Benchmark</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500 mb-2">Tail Ratio</p>
                <p id="tail-ratio" class="text-3xl font-bold text-purple-600">--</p>
                <p class="text-xs text-gray-400">Upside/Downside</p>
            </div>
        </div>
    </div>

    <!-- AI Quantitative Report -->
    <div id="ai-section" class="bg-gradient-to-r from-primary-50 to-indigo-50 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-brain text-primary-600 mr-2"></i>AI Quantitative Analysis Report
        </h3>
        <div id="ai-content" class="prose prose-blue max-w-none"></div>
    </div>
    
</div>

{% endblock %}

{% block extra_js %}
<script>
const EXAMPLE_PORTFOLIO = "AAPL:0.12, MSFT:0.12, GOOGL:0.10, AMZN:0.08, NVDA:0.07, JPM:0.07, JNJ:0.06, V:0.06, PG:0.06, UNH:0.06, HD:0.05, MA:0.05, LLY:0.05, KO:0.03, PEP:0.02";

function loadExample() {
    document.getElementById('holdings-input').value = EXAMPLE_PORTFOLIO;
}

function parseHoldings(input) {
    return input.split(',').map(part => {
        const [ticker, weight] = part.trim().split(':');
        return {
            ticker: ticker.trim().toUpperCase(),
            weight: parseFloat(weight) || 0
        };
    }).filter(h => h.ticker && h.weight > 0);
}

document.getElementById('analysis-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const input = document.getElementById('holdings-input').value;
    const holdings = parseHoldings(input);
    
    if (holdings.length < 2) {
        showToast('Please enter at least 2 holdings', 'error');
        return;
    }
    
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('results-section').classList.add('hidden');
    
    try {
        const response = await apiCall('/api/portfolio/comprehensive-analysis', {
            method: 'POST',
            body: JSON.stringify({
                holdings: holdings,
                period: document.getElementById('period').value,
                portfolio_value: parseFloat(document.getElementById('portfolio-value').value)
            })
        });
        
        displayResults(response);
        
    } catch (error) {
        console.error('Analysis error:', error);
        showToast('Analysis failed: ' + error.message, 'error');
    } finally {
        document.getElementById('loading-state').classList.add('hidden');
    }
});

function displayResults(data) {
    document.getElementById('results-section').classList.remove('hidden');
    
    const m = data.metrics;
    const portfolioValue = parseFloat(document.getElementById('portfolio-value').value);
    
    // Basic metrics
    document.getElementById('metric-return').textContent = formatPercent(m.annualized_return);
    document.getElementById('metric-vol').textContent = formatPercent(m.volatility);
    document.getElementById('metric-dd').textContent = formatPercent(m.max_drawdown);
    document.getElementById('metric-dd-days').textContent = m.max_drawdown_days + ' days';
    document.getElementById('metric-sharpe').textContent = m.sharpe_ratio.toFixed(2);
    document.getElementById('metric-beta').textContent = m.beta.toFixed(2);
    document.getElementById('metric-alpha').textContent = formatPercent(m.alpha);
    
    // Risk-adjusted
    document.getElementById('metric-sortino').textContent = m.sortino_ratio.toFixed(2);
    document.getElementById('metric-calmar').textContent = m.calmar_ratio.toFixed(2);
    document.getElementById('metric-omega').textContent = m.omega_ratio.toFixed(2);
    document.getElementById('metric-info').textContent = m.information_ratio.toFixed(2);
    document.getElementById('metric-treynor').textContent = m.treynor_ratio.toFixed(2);
    
    // Diversification
    document.getElementById('effective-n').textContent = m.effective_n.toFixed(1);
    document.getElementById('concentration').textContent = (m.concentration * 100).toFixed(1) + '%';
    document.getElementById('r-squared').textContent = (m.r_squared * 100).toFixed(1) + '%';
    document.getElementById('tail-ratio').textContent = m.tail_ratio.toFixed(2);
    
    // Confidence intervals
    if (data.confidence_intervals) {
        document.getElementById('ci-return').textContent = 
            `95% CI: ${formatPercent(data.confidence_intervals.mean[0])} to ${formatPercent(data.confidence_intervals.mean[1])}`;
    }
    
    // Holdings table with sectors
    renderHoldingsTable(data.holdings, portfolioValue);
    
    // Distribution analysis
    renderDistributionAnalysis(data.distributions);
    
    // Monte Carlo
    renderMonteCarlo(data.monte_carlo);
    
    // Statistical tests
    renderStatisticalTests(data.statistical_tests);
    
    // VaR
    document.getElementById('var-hist-95').textContent = formatPercent(m.var_95);
    document.getElementById('cvar-95').textContent = formatPercent(m.cvar_95);
    
    // Tail risk
    if (data.tail_risk) {
        document.getElementById('hill-estimator').textContent = data.tail_risk.hill_estimator?.toFixed(3) || 'N/A';
        document.getElementById('gpd-xi').textContent = data.tail_risk.xi_parameter?.toFixed(3) || 'N/A';
        document.getElementById('black-swan-prob').textContent = 
            (data.tail_risk.black_swan_prob * 100)?.toFixed(2) + '%' || 'N/A';
    }
    
    // Volatility analysis
    if (data.volatility_analysis) {
        document.getElementById('vol-of-vol').textContent = 
            (data.volatility_analysis.vol_of_vol * 100)?.toFixed(1) + '%' || '--';
        document.getElementById('vol-persistence').textContent = 
            data.volatility_analysis.volatility_persistence?.toFixed(3) || '--';
        document.getElementById('vol-halflife').textContent = 
            data.volatility_analysis.half_life?.toFixed(1) || '--';
        document.getElementById('arch-effects').textContent = 
            data.volatility_analysis.has_arch_effects ? 'DETECTED' : 'NONE';
        document.getElementById('arch-effects').className = 
            'text-2xl font-bold ' + (data.volatility_analysis.has_arch_effects ? 'text-orange-600' : 'text-green-600');
    }
    
    // PCA
    if (data.pca) {
        document.getElementById('pca-condition').textContent = data.pca.condition_number?.toFixed(1) || '--';
        document.getElementById('pca-rank').textContent = data.pca.effective_rank?.toFixed(1) || '--';
    }
    
    // Charts
    createDrawdownChart(data);
    createRollingBetaChart(data);
    createCorrelationHeatmap(data);
    createStressTestGrid(data);
    
    // NEW: Professional charts
    createMonteCarloChart(data);
    createRollingStatsChart(data);
    createPcaCharts(data);
    createEfficientFrontierChart(data);
    createPerformanceChart(data);
    createVolatilityChart(data);
    createDistributionChart(data);
    createRiskContributionChart(data);
    createMonthlyReturnsHeatmap(data);
    createRollingCorrelationChart(data);
    
    // Performance Tables
    renderPerformanceMetricsTable(data);
    renderRiskMatrixTable(data);
    
    // AI Insights
    renderAIInsights(data.ai_insights);
    
    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
}

function renderHoldingsTable(holdings, portfolioValue) {
    const tbody = document.getElementById('holdings-tbody');
    tbody.innerHTML = '';
    
    if (!holdings) return;
    
    holdings.forEach(h => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100';
        row.innerHTML = `
            <td class="px-4 py-3 font-medium">${h.ticker}</td>
            <td class="px-4 py-3">${h.name || '-'}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 bg-gray-100 rounded text-xs">${h.sector || 'Unknown'}</span>
            </td>
            <td class="px-4 py-3 text-right font-semibold">${(h.weight * 100).toFixed(1)}%</td>
            <td class="px-4 py-3 text-right">$${(h.weight * portfolioValue).toLocaleString()}</td>
            <td class="px-4 py-3 text-right">${h.beta ? h.beta.toFixed(2) : '-'}</td>
            <td class="px-4 py-3 text-right">${h.dividend_yield ? (h.dividend_yield * 100).toFixed(2) + '%' : '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

function renderDistributionAnalysis(distributions) {
    if (!distributions) return;
    
    const container = document.getElementById('distribution-comparison');
    container.innerHTML = '';
    
    Object.entries(distributions).forEach(([name, dist]) => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
        div.innerHTML = `
            <span class="font-medium">${name}</span>
            <div class="text-right">
                <span class="text-sm">VaR 95%: ${formatPercent(dist.var_95)}</span>
                <span class="text-xs text-gray-400 ml-2">AIC: ${dist.aic?.toFixed(0)}</span>
            </div>
        `;
        container.appendChild(div);
    });
    
    // Normality warning
    const normalDist = distributions['Normal'];
    const bestDist = Object.entries(distributions).sort((a, b) => a[1].aic - b[1].aic)[0];
    
    const warningBox = document.getElementById('normality-warning');
    if (bestDist[0] !== 'Normal') {
        warningBox.innerHTML = `
            <p class="text-sm text-yellow-800">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>Non-Normal Distribution Detected:</strong> 
                Returns follow a ${bestDist[0]} distribution better than Normal (lower AIC). 
                Standard risk metrics may underestimate tail risk.
            </p>
        `;
        warningBox.classList.remove('hidden');
    } else {
        warningBox.classList.add('hidden');
    }
}

function renderMonteCarlo(mc) {
    if (!mc) return;
    
    document.getElementById('mc-profit-prob').textContent = (mc.probability_profit * 100).toFixed(1) + '%';
    document.getElementById('mc-target-prob').textContent = (mc.probability_target * 100).toFixed(1) + '%';
    document.getElementById('mc-expected-dd').textContent = formatPercent(mc.expected_max_drawdown);
    document.getElementById('mc-ci').textContent = `$${mc.confidence_interval_95[0].toLocaleString()} - $${mc.confidence_interval_95[1].toLocaleString()}`;
    document.getElementById('mc-worst').textContent = '$' + mc.worst_case?.toLocaleString();
}

function renderStatisticalTests(tests) {
    if (!tests) return;
    
    document.getElementById('jb-stat').textContent = tests.jarque_bera_stat?.toFixed(2);
    document.getElementById('jb-result').textContent = tests.is_normal ? 'Normal ✓' : 'Non-Normal ✗';
    document.getElementById('jb-result').className = 'text-sm ' + (tests.is_normal ? 'text-green-600' : 'text-red-600');
    
    document.getElementById('lb-stat').textContent = tests.ljung_box_stat?.toFixed(2);
    document.getElementById('lb-result').textContent = tests.has_autocorrelation ? 'Autocorr. ✗' : 'No Autocorr. ✓';
    document.getElementById('lb-result').className = 'text-sm ' + (tests.has_autocorrelation ? 'text-red-600' : 'text-green-600');
    
    document.getElementById('sw-stat').textContent = tests.shapiro_wilk_stat?.toFixed(3);
    document.getElementById('sw-result').textContent = tests.shapiro_wilk_pvalue > 0.05 ? 'Normal ✓' : 'Non-Normal ✗';
    
    document.getElementById('arch-stat').textContent = tests.arch_lm_pvalue?.toFixed(3);
    document.getElementById('arch-result').textContent = tests.has_arch_effects ? 'Clustering ✗' : 'No Clustering ✓';
    document.getElementById('arch-result').className = 'text-sm ' + (tests.has_arch_effects ? 'text-orange-600' : 'text-green-600');
}

function createDrawdownChart(data) {
    if (!data.drawdown_series) return;
    
    const trace = {
        x: data.drawdown_series.dates,
        y: data.drawdown_series.drawdown.map(v => v * 100),
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        fillcolor: 'rgba(239, 68, 68, 0.2)',
        line: { color: '#ef4444', width: 1 },
        name: 'Drawdown'
    };
    
    Plotly.newPlot('drawdown-chart', [trace], {
        margin: { t: 20, r: 20, b: 40, l: 60 },
        yaxis: { title: 'Drawdown (%)' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
    }, {displayModeBar: false});
}

function createRollingBetaChart(data) {
    if (!data.rolling_metrics) return;
    
    const rm = data.rolling_metrics;
    
    const trace = {
        x: rm.dates,
        y: rm.beta,
        type: 'scatter',
        mode: 'lines',
        line: { color: '#8b5cf6' },
        name: 'Beta'
    };
    
    const layout = {
        margin: { t: 20, r: 20, b: 40, l: 60 },
        yaxis: { title: 'Beta', rangemode: 'tozero' },
        shapes: [{
            type: 'line',
            x0: rm.dates[0],
            x1: rm.dates[rm.dates.length - 1],
            y0: 1,
            y1: 1,
            line: { color: 'gray', dash: 'dash' }
        }],
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    Plotly.newPlot('rolling-beta-chart', [trace], layout, {displayModeBar: false});
}

function createCorrelationHeatmap(data) {
    if (!data.correlation_matrix) return;
    
    const tickers = Object.keys(data.correlation_matrix);
    const matrix = tickers.map(t1 => tickers.map(t2 => data.correlation_matrix[t1][t2]));
    
    const trace = {
        z: matrix,
        x: tickers,
        y: tickers,
        type: 'heatmap',
        colorscale: [[0, '#3b82f6'], [0.5, '#ffffff'], [1, '#ef4444']],
        zmid: 0,
        zmin: -1,
        zmax: 1,
        text: matrix.map(row => row.map(v => v.toFixed(2))),
        texttemplate: '%{text}',
        textfont: { size: 10 }
    };
    
    Plotly.newPlot('correlation-heatmap', [trace], {
        margin: { t: 20, r: 20, b: 60, l: 80 }
    }, {displayModeBar: false});
}

function createStressTestGrid(data) {
    if (!data.stress_test) return;
    
    const grid = document.getElementById('stress-test-grid');
    grid.innerHTML = '';
    
    Object.entries(data.stress_test).forEach(([scenario, impact]) => {
        const div = document.createElement('div');
        div.className = 'bg-red-50 rounded-lg p-4 text-center';
        div.innerHTML = `
            <p class="text-sm text-red-700 font-medium">${scenario}</p>
            <p class="text-2xl font-bold text-red-600 mt-1">${(impact * 100).toFixed(1)}%</p>
        `;
        grid.appendChild(div);
    });
}

// ============== PROFESSIONAL CHART RENDERING FUNCTIONS ==============

/**
 * Monte Carlo Simulation Chart with Percentile Bands
 */
function createMonteCarloChart(data) {
    if (!data.charts || !data.charts.monte_carlo) return;
    
    const mc = data.charts.monte_carlo;
    const chartDiv = document.getElementById('monte-carlo-chart');
    if (!chartDiv) return;
    
    const traces = [];
    
    // Sample paths (grey, low opacity)
    if (mc.paths) {
        mc.paths.forEach((path, i) => {
            if (i % 5 === 0) { // Show every 5th path for performance
                traces.push({
                    x: mc.days,
                    y: path,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'rgba(150,150,150,0.1)', width: 1 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
        });
    }
    
    // Percentile bands
    if (mc.percentiles) {
        const bands = [
            { name: '95th %ile', key: 'p95', color: 'rgba(59,130,246,0.3)' },
            { name: '75th %ile', key: 'p75', color: 'rgba(59,130,246,0.2)' },
            { name: '50th %ile', key: 'p50', color: '#3b82f6', width: 3 },
            { name: '25th %ile', key: 'p25', color: 'rgba(59,130,246,0.2)' },
            { name: '5th %ile', key: 'p5', color: 'rgba(59,130,246,0.3)' }
        ];
        
        // Fill between bands
        if (mc.percentiles.p95 && mc.percentiles.p5) {
            traces.push({
                x: mc.days.concat([...mc.days].reverse()),
                y: mc.percentiles.p95.concat([...mc.percentiles.p5].reverse()),
                fill: 'toself',
                fillcolor: 'rgba(59,130,246,0.1)',
                line: { color: 'transparent' },
                name: '90% CI',
                showlegend: true,
                hoverinfo: 'skip'
            });
        }
        
        // Median line
        if (mc.percentiles.p50) {
            traces.push({
                x: mc.days,
                y: mc.percentiles.p50,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#3b82f6', width: 3 },
                name: 'Median',
                showlegend: true
            });
        }
    }
    
    const layout = {
        title: { text: '1-Year Monte Carlo Simulation (5,000 Paths)', font: { size: 14 } },
        xaxis: { title: 'Days', gridcolor: '#f0f0f0' },
        yaxis: { 
            title: 'Portfolio Value ($)', 
            gridcolor: '#f0f0f0',
            tickformat: '$,.0f'
        },
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 60 },
        annotations: [{
            x: mc.days[mc.days.length - 1],
            y: mc.percentiles?.p50?.[mc.percentiles.p50.length - 1] || mc.initial_value,
            text: 'Expected',
            showarrow: true,
            arrowhead: 2,
            ax: 40,
            ay: -30
        }]
    };
    
    Plotly.newPlot('monte-carlo-chart', traces, layout, {displayModeBar: false});
}

/**
 * Rolling Statistics with Confidence Bands
 */
function createRollingStatsChart(data) {
    if (!data.charts || !data.charts.rolling_stats_63d) return;
    
    const rs = data.charts.rolling_stats_63d;
    if (!rs.dates || !rs.mean) return;
    
    const traces = [
        // Upper confidence band
        {
            x: rs.dates,
            y: rs.mean_upper,
            type: 'scatter',
            mode: 'lines',
            line: { color: 'transparent' },
            showlegend: false,
            hoverinfo: 'skip'
        },
        // Lower confidence band (fill between)
        {
            x: rs.dates,
            y: rs.mean_lower,
            type: 'scatter',
            mode: 'lines',
            fill: 'tonexty',
            fillcolor: 'rgba(59,130,246,0.15)',
            line: { color: 'transparent' },
            name: '95% CI',
            hoverinfo: 'skip'
        },
        // Mean line
        {
            x: rs.dates,
            y: rs.mean,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#3b82f6', width: 2 },
            name: 'Rolling Mean (Ann.)'
        },
        // Standard deviation (secondary axis)
        {
            x: rs.dates,
            y: rs.std,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#f97316', width: 2, dash: 'dash' },
            name: 'Volatility',
            yaxis: 'y2'
        }
    ];
    
    const layout = {
        title: { text: '63-Day Rolling Statistics with Confidence Bands', font: { size: 14 } },
        xaxis: { title: '', gridcolor: '#f0f0f0' },
        yaxis: { 
            title: 'Annualized Return', 
            gridcolor: '#f0f0f0',
            tickformat: '.1%'
        },
        yaxis2: {
            title: 'Volatility',
            overlaying: 'y',
            side: 'right',
            tickformat: '.1%',
            showgrid: false
        },
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 60, b: 40, l: 60 }
    };
    
    Plotly.newPlot('rolling-stats-chart', traces, layout, {displayModeBar: false});
}

/**
 * PCA Charts: Scree Plot and Loadings
 */
function createPcaCharts(data) {
    if (!data.charts || !data.charts.pca) return;
    
    const pca = data.charts.pca;
    
    // Scree Plot (Explained Variance)
    if (pca.explained_variance && pca.cumulative_variance) {
        const labels = pca.explained_variance.map((_, i) => `PC${i+1}`);
        
        const traces = [
            {
                x: labels,
                y: pca.explained_variance,
                type: 'bar',
                name: 'Individual',
                marker: { color: '#3b82f6' }
            },
            {
                x: labels,
                y: pca.cumulative_variance,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Cumulative',
                line: { color: '#f97316', width: 2 },
                marker: { size: 8 },
                yaxis: 'y2'
            }
        ];
        
        const layout = {
            title: { text: 'Explained Variance by Component', font: { size: 14 } },
            xaxis: { title: 'Principal Component' },
            yaxis: { 
                title: 'Variance Explained',
                tickformat: '.1%',
                range: [0, Math.max(...pca.explained_variance) * 1.2]
            },
            yaxis2: {
                title: 'Cumulative',
                overlaying: 'y',
                side: 'right',
                tickformat: '.1%',
                range: [0, 1.1],
                showgrid: false
            },
            showlegend: true,
            legend: { x: 0.02, y: 0.98 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: { t: 40, r: 60, b: 40, l: 60 }
        };
        
        Plotly.newPlot('pca-variance-chart', traces, layout, {displayModeBar: false});
    }
    
    // Loadings Chart
    if (pca.loadings && pca.tickers) {
        const loadings = pca.loadings;
        const traces = [];
        
        // Create traces for first 3 components
        const colors = ['#3b82f6', '#f97316', '#22c55e'];
        const components = ['PC1', 'PC2', 'PC3'];
        
        for (let i = 0; i < Math.min(3, loadings.length > 0 && loadings[0].length); i++) {
            traces.push({
                x: pca.tickers,
                y: loadings.map(row => row[i]),
                type: 'bar',
                name: components[i],
                marker: { color: colors[i] }
            });
        }
        
        const layout = {
            title: { text: 'Factor Loadings (Component Weights)', font: { size: 14 } },
            xaxis: { title: '', tickangle: -45 },
            yaxis: { title: 'Loading', gridcolor: '#f0f0f0' },
            barmode: 'group',
            showlegend: true,
            legend: { x: 0.02, y: 0.98 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: { t: 40, r: 20, b: 80, l: 60 }
        };
        
        Plotly.newPlot('pca-loadings-chart', traces, layout, {displayModeBar: false});
    }
}

/**
 * Efficient Frontier Chart
 */
function createEfficientFrontierChart(data) {
    if (!data.charts || !data.charts.efficient_frontier) return;
    
    const ef = data.charts.efficient_frontier;
    const traces = [];
    
    // Random portfolios cloud
    if (ef.random_portfolios) {
        traces.push({
            x: ef.random_portfolios.volatility,
            y: ef.random_portfolios.returns,
            mode: 'markers',
            type: 'scatter',
            marker: {
                color: ef.random_portfolios.sharpe,
                colorscale: 'Viridis',
                size: 5,
                opacity: 0.6,
                colorbar: { title: 'Sharpe', thickness: 15 }
            },
            name: 'Random Portfolios',
            hovertemplate: 'Vol: %{x:.1%}<br>Ret: %{y:.1%}<br>Sharpe: %{marker.color:.2f}'
        });
    }
    
    // Current portfolio
    if (ef.current_portfolio) {
        traces.push({
            x: [ef.current_portfolio.volatility],
            y: [ef.current_portfolio.return],
            mode: 'markers',
            type: 'scatter',
            marker: { color: '#ef4444', size: 15, symbol: 'star' },
            name: 'Your Portfolio',
            hovertemplate: 'Your Portfolio<br>Vol: %{x:.1%}<br>Ret: %{y:.1%}'
        });
    }
    
    // Max Sharpe portfolio
    if (ef.max_sharpe) {
        traces.push({
            x: [ef.max_sharpe.volatility],
            y: [ef.max_sharpe.return],
            mode: 'markers',
            type: 'scatter',
            marker: { color: '#22c55e', size: 12, symbol: 'diamond' },
            name: 'Max Sharpe',
            hovertemplate: 'Max Sharpe<br>Vol: %{x:.1%}<br>Ret: %{y:.1%}<br>Sharpe: ' + ef.max_sharpe.sharpe.toFixed(2)
        });
    }
    
    // Min volatility portfolio
    if (ef.min_vol) {
        traces.push({
            x: [ef.min_vol.volatility],
            y: [ef.min_vol.return],
            mode: 'markers',
            type: 'scatter',
            marker: { color: '#3b82f6', size: 12, symbol: 'square' },
            name: 'Min Volatility',
            hovertemplate: 'Min Vol<br>Vol: %{x:.1%}<br>Ret: %{y:.1%}'
        });
    }
    
    // Efficient frontier curve
    if (ef.efficient_frontier) {
        traces.push({
            x: ef.efficient_frontier.volatility,
            y: ef.efficient_frontier.returns,
            mode: 'lines',
            type: 'scatter',
            line: { color: '#8b5cf6', width: 3, dash: 'solid' },
            name: 'Efficient Frontier',
            hoverinfo: 'skip'
        });
    }
    
    const layout = {
        title: { text: 'Mean-Variance Optimization (Markowitz)', font: { size: 14 } },
        xaxis: { 
            title: 'Annualized Volatility',
            tickformat: '.1%',
            gridcolor: '#f0f0f0'
        },
        yaxis: { 
            title: 'Annualized Return',
            tickformat: '.1%',
            gridcolor: '#f0f0f0'
        },
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 80, b: 40, l: 60 }
    };
    
    // Create container if not exists
    let container = document.getElementById('efficient-frontier-chart');
    if (!container) {
        container = document.createElement('div');
        container.id = 'efficient-frontier-chart';
        container.className = 'h-80';
        
        // Insert after correlation heatmap
        const resultsSection = document.getElementById('results-section');
        const chartSection = document.createElement('div');
        chartSection.className = 'bg-white rounded-xl shadow-lg p-6';
        chartSection.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-scatter text-primary-600 mr-2"></i>Efficient Frontier Analysis
            </h3>
            <div id="efficient-frontier-chart" class="h-80"></div>
        `;
        resultsSection.insertBefore(chartSection, document.getElementById('ai-section'));
    }
    
    Plotly.newPlot('efficient-frontier-chart', traces, layout, {displayModeBar: false});
}

/**
 * Performance Comparison Chart with Benchmarks
 */
function createPerformanceChart(data) {
    if (!data.charts || !data.charts.performance) return;
    
    const perf = data.charts.performance;
    const traces = [];
    
    // Portfolio cumulative return
    if (perf.portfolio && perf.portfolio.values) {
        traces.push({
            x: perf.portfolio.dates,
            y: perf.portfolio.values,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#3b82f6', width: 2.5 },
            name: 'Your Portfolio',
            fill: 'tozeroy',
            fillcolor: 'rgba(59,130,246,0.1)'
        });
    }
    
    // Benchmarks
    const benchmarkColors = { 'S&P 500': '#f97316', 'FTSE 100': '#22c55e', 'MSCI World': '#8b5cf6', 'NASDAQ': '#ef4444', 'Bonds (AGG)': '#8b5cf6' };
    if (perf.benchmarks) {
        Object.entries(perf.benchmarks).forEach(([name, bench]) => {
            traces.push({
                x: bench.dates,
                y: bench.values,
                type: 'scatter',
                mode: 'lines',
                line: { color: bench.color || benchmarkColors[name] || '#94a3b8', width: 1.5, dash: 'dash' },
                name: name,
                opacity: 0.8
            });
        });
    }
    
    const layout = {
        title: { text: 'Performance vs Benchmarks (Cumulative Returns)', font: { size: 14 } },
        xaxis: { title: '', gridcolor: '#f0f0f0' },
        yaxis: { 
            title: 'Cumulative Return',
            tickformat: '.1%',
            gridcolor: '#f0f0f0'
        },
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 60 }
    };
    
    // Create container
    let container = document.getElementById('performance-chart');
    if (!container) {
        const resultsSection = document.getElementById('results-section');
        const chartSection = document.createElement('div');
        chartSection.className = 'bg-white rounded-xl shadow-lg p-6';
        chartSection.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-line text-primary-600 mr-2"></i>Benchmark Comparison
            </h3>
            <div id="performance-chart" class="h-80"></div>
        `;
        resultsSection.insertBefore(chartSection, document.getElementById('ai-section'));
    }
    
    Plotly.newPlot('performance-chart', traces, layout, {displayModeBar: false});
}

/**
 * Volatility Clustering Chart
 */
function createVolatilityChart(data) {
    if (!data.volatility_analysis || !data.volatility_analysis.volatility_series) return;
    
    const vol = data.volatility_analysis.volatility_series;
    const traces = [
        {
            x: vol.dates,
            y: vol.values,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#f97316', width: 1.5 },
            name: 'Realized Volatility',
            fill: 'tozeroy',
            fillcolor: 'rgba(249,115,22,0.1)'
        }
    ];
    
    // Add rolling mean if available
    if (vol.rolling_mean) {
        traces.push({
            x: vol.dates,
            y: vol.rolling_mean,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#3b82f6', width: 2 },
            name: '21-Day MA'
        });
    }
    
    const layout = {
        title: { text: 'Realized Volatility (21-Day Rolling)', font: { size: 14 } },
        xaxis: { title: '', gridcolor: '#f0f0f0' },
        yaxis: { 
            title: 'Volatility (Ann.)',
            tickformat: '.1%',
            gridcolor: '#f0f0f0'
        },
        showlegend: true,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 60 }
    };
    
    Plotly.newPlot('volatility-chart', traces, layout, {displayModeBar: false});
}

/**
 * Return Distribution Histogram with PDF overlay
 */
function createDistributionChart(data) {
    if (!data.returns_distribution || !data.returns_distribution.returns) {
        // Try to use just the raw returns from portfolio
        if (!data.portfolio_returns) return;
        
        const returns = data.portfolio_returns;
        const trace = {
            x: returns,
            type: 'histogram',
            histnorm: 'probability density',
            marker: { color: 'rgba(59,130,246,0.6)' },
            nbinsx: 40,
            name: 'Returns'
        };
        
        const layout = {
            title: { text: 'Return Distribution', font: { size: 14 } },
            xaxis: { title: 'Daily Return', tickformat: '.1%', gridcolor: '#f0f0f0' },
            yaxis: { title: 'Density', gridcolor: '#f0f0f0' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: { t: 40, r: 20, b: 40, l: 60 }
        };
        
        Plotly.newPlot('distribution-chart', [trace], layout, {displayModeBar: false});
        return;
    }
    
    const dist = data.returns_distribution;
    
    const traces = [
        // Histogram
        {
            x: dist.returns,
            type: 'histogram',
            name: 'Returns',
            histnorm: 'probability density',
            marker: { color: 'rgba(59,130,246,0.5)' },
            nbinsx: 40,
            showlegend: false
        }
    ];
    
    // Add fitted distribution if available
    if (dist.pdf_fitted && dist.pdf_fitted.length > 0) {
        traces.push({
            x: dist.x_values,
            y: dist.pdf_fitted,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#ef4444', width: 2 },
            name: dist.best_fit || 'Fitted',
            showlegend: false
        });
    }
    
    // Add normal overlay if available
    if (dist.pdf_normal && dist.pdf_normal.length > 0) {
        traces.push({
            x: dist.x_values,
            y: dist.pdf_normal,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#94a3b8', width: 2, dash: 'dash' },
            name: 'Normal',
            showlegend: false
        });
    }
    
    // Add VaR line
    if (dist.var_95 !== undefined) {
        const maxY = Math.max(...(dist.pdf_fitted || [1])) * 0.8 || 1;
        traces.push({
            x: [dist.var_95, dist.var_95],
            y: [0, maxY],
            type: 'scatter',
            mode: 'lines',
            line: { color: '#dc2626', width: 2 },
            name: 'VaR 95%',
            showlegend: false
        });
    }
    
    const layout = {
        title: { text: `Return Distribution ${dist.best_fit ? '(' + dist.best_fit + ')' : ''}`, font: { size: 14 } },
        xaxis: { 
            title: 'Daily Return',
            tickformat: '.1%',
            gridcolor: '#f0f0f0'
        },
        yaxis: { 
            title: 'Probability Density',
            gridcolor: '#f0f0f0'
        },
        annotations: [{
            x: dist.var_95 || -0.02,
            y: Math.max(...(dist.pdf_fitted || [1])) * 0.85,
            text: 'VaR 95%',
            showarrow: false,
            font: { color: '#dc2626', size: 10 }
        }],
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 60 }
    };
    
    Plotly.newPlot('distribution-chart', traces, layout, {displayModeBar: false});
}

/**
 * AI Insights Renderer
 */
function renderAIInsights(insights) {
    const container = document.getElementById('ai-content');
    if (!container || !insights) return;
    
    let html = '<div class="space-y-4">';
    
    // Risk Assessment
    if (insights.risk_assessment) {
        html += `
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <h4 class="font-semibold text-gray-900 mb-2">
                    <i class="fas fa-shield-alt text-red-500 mr-2"></i>Risk Assessment
                </h4>
                <p class="text-gray-700 text-sm leading-relaxed">${insights.risk_assessment}</p>
            </div>
        `;
    }
    
    // Factor Analysis
    if (insights.factor_analysis) {
        html += `
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <h4 class="font-semibold text-gray-900 mb-2">
                    <i class="fas fa-project-diagram text-blue-500 mr-2"></i>Factor Analysis
                </h4>
                <p class="text-gray-700 text-sm leading-relaxed">${insights.factor_analysis}</p>
            </div>
        `;
    }
    
    // Recommendations
    if (insights.recommendation) {
        html += `
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <h4 class="font-semibold text-gray-900 mb-2">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Recommendations
                </h4>
                <p class="text-gray-700 text-sm leading-relaxed">${insights.recommendation}</p>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

/**
 * Performance Metrics Table Renderer
 */
function renderPerformanceMetricsTable(data) {
    const tbody = document.getElementById('performance-metrics-tbody');
    if (!tbody || !data.metrics) return;
    
    const m = data.metrics;
    const ci = data.confidence_intervals || {};
    
    // Get benchmark metrics if available
    const bench = data.benchmark_metrics || {};
    
    const metrics = [
        { name: 'Annualized Return', port: m.annualized_return, spy: bench.spy?.return, urth: bench.urth?.return, ci: ci.annualized_return },
        { name: 'Volatility', port: m.volatility, spy: bench.spy?.volatility, urth: bench.urth?.volatility, ci: ci.volatility },
        { name: 'Sharpe Ratio', port: m.sharpe_ratio, spy: bench.spy?.sharpe, urth: bench.urth?.sharpe, ci: ci.sharpe_ratio },
        { name: 'Max Drawdown', port: m.max_drawdown, spy: bench.spy?.max_drawdown, urth: bench.urth?.max_drawdown, ci: ci.max_drawdown },
        { name: 'Sortino Ratio', port: m.sortino_ratio, spy: null, urth: null, ci: ci.sortino_ratio },
        { name: 'Beta', port: m.beta, spy: 1.0, urth: null, ci: ci.beta }
    ];
    
    tbody.innerHTML = metrics.map(metric => `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 font-medium">${metric.name}</td>
            <td class="px-4 py-3 text-right font-semibold ${getMetricColor(metric.port, metric.name)}">
                ${formatMetric(metric.port, metric.name)}
            </td>
            <td class="px-4 py-3 text-right text-gray-600">
                ${metric.spy !== null ? formatMetric(metric.spy, metric.name) : '-'}
            </td>
            <td class="px-4 py-3 text-right text-gray-600">
                ${metric.urth !== null ? formatMetric(metric.urth, metric.name) : '-'}
            </td>
            <td class="px-4 py-3 text-right text-gray-500">
                ${metric.ci ? formatMetric(metric.ci[0], metric.name) : '-'}
            </td>
            <td class="px-4 py-3 text-right text-gray-500">
                ${metric.ci ? formatMetric(metric.ci[1], metric.name) : '-'}
            </td>
        </tr>
    `).join('');
}

function getMetricColor(value, metricName) {
    if (value === null || value === undefined) return 'text-gray-400';
    
    if (metricName.includes('Return') || metricName.includes('Sharpe') || metricName.includes('Sortino')) {
        return value > 0 ? 'text-green-600' : value < 0 ? 'text-red-600' : 'text-gray-600';
    }
    if (metricName.includes('Drawdown') || metricName.includes('Volat')) {
        return value > 0.25 ? 'text-red-600' : value > 0.15 ? 'text-orange-600' : 'text-green-600';
    }
    return 'text-gray-900';
}

function formatMetric(value, metricName) {
    if (value === null || value === undefined) return '-';
    
    if (metricName.includes('Return') || metricName.includes('Drawdown') || metricName.includes('Volat')) {
        return (value * 100).toFixed(2) + '%';
    }
    return value.toFixed(2);
}

/**
 * Risk Matrix Table Renderer
 */
function renderRiskMatrixTable(data) {
    const tbody = document.getElementById('risk-matrix-tbody');
    if (!tbody || !data.metrics) return;
    
    const m = data.metrics;
    
    const risks = [
        { 
            factor: 'Volatility', 
            value: m.volatility, 
            format: 'pct',
            levels: [{ max: 0.15, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.25, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
            interpretation: 'Annualized standard deviation of returns'
        },
        { 
            factor: 'Maximum Drawdown', 
            value: Math.abs(m.max_drawdown), 
            format: 'pct',
            levels: [{ max: 0.15, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.25, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
            interpretation: 'Largest peak-to-trough decline'
        },
        { 
            factor: 'VaR (95%)', 
            value: Math.abs(m.var_95), 
            format: 'pct',
            levels: [{ max: 0.02, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.035, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
            interpretation: 'Daily loss not exceeded 95% of the time'
        },
        { 
            factor: 'CVaR (95%)', 
            value: Math.abs(m.cvar_95), 
            format: 'pct',
            levels: [{ max: 0.025, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.045, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
            interpretation: 'Expected loss given VaR is exceeded'
        },
        { 
            factor: 'Beta', 
            value: m.beta, 
            format: 'num',
            levels: [{ max: 0.8, level: 'Defensive', color: 'bg-blue-100 text-blue-800' }, { max: 1.1, level: 'Neutral', color: 'bg-green-100 text-green-800' }, { max: 10, level: 'Aggressive', color: 'bg-orange-100 text-orange-800' }],
            interpretation: 'Sensitivity to market movements'
        },
        { 
            factor: 'Concentration (HHI)', 
            value: m.concentration, 
            format: 'pct',
            levels: [{ max: 0.15, level: 'Diversified', color: 'bg-green-100 text-green-800' }, { max: 0.25, level: 'Moderate', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'Concentrated', color: 'bg-red-100 text-red-800' }],
            interpretation: 'Portfolio concentration risk'
        }
    ];
    
    tbody.innerHTML = risks.map(risk => {
        const level = risk.levels.find(l => risk.value <= l.max) || risk.levels[risk.levels.length - 1];
        const formatted = risk.format === 'pct' ? (risk.value * 100).toFixed(2) + '%' : risk.value.toFixed(2);
        
        return `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="px-4 py-3 font-medium">${risk.factor}</td>
                <td class="px-4 py-3 text-right font-mono">${formatted}</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${level.color}">${level.level}</span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-600">${risk.interpretation}</td>
            </tr>
        `;
    }).join('');
}

// ============== ADDITIONAL PROFESSIONAL RISK ANALYSIS CHARTS ==============

/**
 * Risk Metrics Gauge Chart
 */
function createRiskGaugeChart(data, containerId) {
    const m = data.metrics;
    if (!m) return;
    
    const gauges = [
        {
            domain: { x: [0, 0.3], y: [0, 1] },
            value: m.sharpe_ratio,
            title: { text: 'Sharpe' },
            type: 'indicator',
            mode: 'gauge+number',
            gauge: {
                axis: { range: [-1, 3] },
                bar: { color: m.sharpe_ratio > 1 ? '#22c55e' : m.sharpe_ratio > 0 ? '#f97316' : '#ef4444' },
                steps: [
                    { range: [-1, 0], color: '#fee2e2' },
                    { range: [0, 1], color: '#ffedd5' },
                    { range: [1, 3], color: '#dcfce7' }
                ]
            }
        },
        {
            domain: { x: [0.35, 0.65], y: [0, 1] },
            value: m.volatility * 100,
            title: { text: 'Volatility %' },
            type: 'indicator',
            mode: 'gauge+number',
            gauge: {
                axis: { range: [0, 50] },
                bar: { color: m.volatility < 0.15 ? '#22c55e' : m.volatility < 0.25 ? '#f97316' : '#ef4444' },
                steps: [
                    { range: [0, 15], color: '#dcfce7' },
                    { range: [15, 25], color: '#ffedd5' },
                    { range: [25, 50], color: '#fee2e2' }
                ]
            }
        },
        {
            domain: { x: [0.7, 1], y: [0, 1] },
            value: Math.abs(m.max_drawdown) * 100,
            title: { text: 'Max DD %' },
            type: 'indicator',
            mode: 'gauge+number',
            gauge: {
                axis: { range: [0, 50] },
                bar: { color: Math.abs(m.max_drawdown) < 0.15 ? '#22c55e' : Math.abs(m.max_drawdown) < 0.25 ? '#f97316' : '#ef4444' },
                steps: [
                    { range: [0, 15], color: '#dcfce7' },
                    { range: [15, 25], color: '#ffedd5' },
                    { range: [25, 50], color: '#fee2e2' }
                ]
            }
        }
    ];
    
    const layout = { 
        height: 200, 
        margin: { t: 30, r: 20, b: 20, l: 20 },
        paper_bgcolor: 'rgba(0,0,0,0)'
    };
    
    Plotly.newPlot(containerId, gauges, layout, {displayModeBar: false});
}

/**
 * Risk-Return Scatter with Efficient Frontier
 */
function createRiskReturnScatter(data) {
    if (!data.efficient_frontier) return;
    
    const ef = data.efficient_frontier;
    const traces = [
        // Current portfolio
        {
            x: [ef.current?.volatility || 0.15],
            y: [ef.current?.return || 0.08],
            mode: 'markers',
            type: 'scatter',
            marker: { size: 20, color: '#ef4444', symbol: 'star' },
            name: 'Current',
            text: ['Your Portfolio'],
            hoverinfo: 'text+x+y'
        }
    ];
    
    // Individual assets
    if (ef.assets) {
        traces.push({
            x: ef.assets.map(a => a.volatility),
            y: ef.assets.map(a => a.return),
            mode: 'markers+text',
            type: 'scatter',
            marker: { size: 10, color: '#3b82f6' },
            text: ef.assets.map(a => a.ticker),
            textposition: 'top center',
            name: 'Assets',
            hoverinfo: 'text+x+y'
        });
    }
    
    const layout = {
        xaxis: { title: 'Volatility', tickformat: '.1%' },
        yaxis: { title: 'Expected Return', tickformat: '.1%' },
        showlegend: false,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    return { traces, layout };
}

/**
 * Tail Risk Waterfall Chart
 */
function createTailRiskChart(data) {
    if (!data.metrics) return;
    
    const m = data.metrics;
    const waterfall = {
        type: 'waterfall',
        orientation: 'v',
        x: ['Expected Return', 'VaR 95%', 'CVaR 95%', 'Worst Case'],
        y: [
            m.annualized_return * 100,
            -(m.var_95 * 100 - m.annualized_return * 100),
            -(m.cvar_95 * 100 - m.var_95 * 100),
            -(Math.abs(m.max_drawdown) * 100 - m.cvar_95 * 100)
        ],
        measure: ['absolute', 'relative', 'relative', 'relative'],
        connector: { line: { color: 'rgb(63, 63, 63)' } },
        decreasing: { marker: { color: '#ef4444' } },
        increasing: { marker: { color: '#22c55e' } }
    };
    
    const layout = {
        title: 'Return Distribution Waterfall',
        yaxis: { title: '%', tickformat: '.1f' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    return { data: [waterfall], layout };
}

/**
 * Risk Contribution Chart
 */
function createRiskContributionChart(data) {
    if (!data.charts || !data.charts.risk_contribution) return;
    
    const rc = data.charts.risk_contribution;
    if (!rc.tickers || !rc.component_risk) return;
    
    // Risk contribution pie chart
    const pieTrace = {
        values: rc.component_risk.map(v => Math.abs(v)),
        labels: rc.tickers,
        type: 'pie',
        hole: 0.4,
        name: 'Risk Contribution',
        textinfo: 'label+percent',
        textposition: 'outside',
        marker: {
            colors: rc.component_risk.map((v, i) => {
                const colors = ['#3b82f6', '#f97316', '#22c55e', '#8b5cf6', '#ef4444', '#06b6d4', '#f59e0b', '#84cc16'];
                return colors[i % colors.length];
            })
        }
    };
    
    const pieLayout = {
        title: { text: 'Component Risk Contribution', font: { size: 14 } },
        showlegend: false,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 20, l: 20 }
    };
    
    Plotly.newPlot('risk-contribution-chart', [pieTrace], pieLayout, {displayModeBar: false});
    
    // Update weight concentration info
    const weightConcDiv = document.getElementById('weight-concentration');
    if (weightConcDiv) {
        const totalRisk = rc.component_risk.reduce((a, b) => a + Math.abs(b), 0);
        const top3Risk = rc.component_risk
            .map((v, i) => ({ ticker: rc.tickers[i], risk: Math.abs(v) }))
            .sort((a, b) => b.risk - a.risk)
            .slice(0, 3);
        
        const top3Pct = (top3Risk.reduce((a, b) => a + b.risk, 0) / totalRisk * 100).toFixed(1);
        
        weightConcDiv.innerHTML = `
            <p class="text-sm"><strong>Top 3 Risk Contributors:</strong> ${top3Risk.map(r => r.ticker).join(', ')}</p>
            <p class="text-sm mt-1">Concentration: ${top3Pct}% of total risk</p>
        `;
    }
}

/**
 * Rolling Correlation Chart
 */
function createRollingCorrelationChart(data) {
    if (!data.charts || !data.charts.rolling_correlation) return;
    
    const rc = data.charts.rolling_correlation;
    if (!rc.correlations || !rc.dates) return;
    
    const traces = Object.entries(rc.correlations).slice(0, 5).map(([pairName, values], i) => ({
        x: rc.dates,
        y: values,
        type: 'scatter',
        mode: 'lines',
        name: pairName,
        line: { width: 1.5 },
        opacity: 0.8
    }));
    
    // Add horizontal line at 0
    traces.push({
        x: [rc.dates[0], rc.dates[rc.dates.length - 1]],
        y: [0, 0],
        type: 'scatter',
        mode: 'lines',
        line: { color: '#94a3b8', width: 1, dash: 'dash' },
        showlegend: false,
        hoverinfo: 'skip'
    });
    
    const layout = {
        title: { text: '90-Day Rolling Pairwise Correlations', font: { size: 14 } },
        xaxis: { title: '', gridcolor: '#f0f0f0' },
        yaxis: { title: 'Correlation', range: [-1, 1], gridcolor: '#f0f0f0' },
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 60 }
    };
    
    // Create container if not exists
    let container = document.getElementById('rolling-correlation-chart');
    if (!container) {
        const resultsSection = document.getElementById('results-section');
        const chartSection = document.createElement('div');
        chartSection.className = 'bg-white rounded-xl shadow-lg p-6';
        chartSection.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-wave-square text-primary-600 mr-2"></i>Rolling Correlations
            </h3>
            <div id="rolling-correlation-chart" class="h-80"></div>
        `;
        resultsSection.insertBefore(chartSection, document.getElementById('ai-section'));
        container = document.getElementById('rolling-correlation-chart');
    }
    
    Plotly.newPlot('rolling-correlation-chart', traces, layout, {displayModeBar: false});
}

/**
 * Drawdown Duration Distribution
 */
function createDrawdownDurationChart(data) {
    if (!data.drawdown_periods) return;
    
    const periods = data.drawdown_periods;
    const durations = periods.map(p => p.duration);
    
    const trace = {
        x: durations,
        type: 'histogram',
        nbinsx: 20,
        marker: { color: 'rgba(239,68,68,0.6)' },
        name: 'Drawdown Duration (days)'
    };
    
    const layout = {
        title: 'Drawdown Duration Distribution',
        xaxis: { title: 'Days' },
        yaxis: { title: 'Frequency' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    return { data: [trace], layout };
}

/**
 * Monthly Returns Heatmap
 */
function createMonthlyReturnsHeatmap(data) {
    if (!data.charts || !data.charts.monthly_returns) return;
    
    const mr = data.charts.monthly_returns;
    if (!mr.data || !mr.years) return;
    
    const trace = {
        z: mr.data,
        x: mr.months || ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        y: mr.years.map(String),
        type: 'heatmap',
        colorscale: [
            [0, '#dc2626'],
            [0.25, '#fca5a5'],
            [0.5, '#ffffff'],
            [0.75, '#86efac'],
            [1, '#16a34a']
        ],
        zmid: 0,
        text: mr.data.map(row => row.map(v => v !== null ? (v * 100).toFixed(1) + '%' : '')),
        texttemplate: '%{text}',
        textfont: { size: 10 },
        hovertemplate: '%{y} %{x}: %{z:.1%}<extra></extra>'
    };
    
    const layout = {
        title: { text: 'Monthly Returns Heatmap', font: { size: 14 } },
        xaxis: { title: '' },
        yaxis: { title: '', autorange: 'reversed' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 40, r: 20, b: 40, l: 50 }
    };
    
    Plotly.newPlot('monthly-returns-heatmap', [trace], layout, {displayModeBar: false});
}

/**
 * Sector Allocation Sunburst
 */
function createSectorAllocationChart(data) {
    if (!data.holdings) return;
    
    // Group by sector
    const sectors = {};
    data.holdings.forEach(h => {
        const sector = h.sector || 'Unknown';
        if (!sectors[sector]) sectors[sector] = [];
        sectors[sector].push(h);
    });
    
    const labels = [];
    const parents = [];
    const values = [];
    
    // Root
    labels.push('Portfolio');
    parents.push('');
    values.push(1);
    
    // Sectors
    Object.entries(sectors).forEach(([sector, holdings]) => {
        labels.push(sector);
        parents.push('Portfolio');
        const sectorWeight = holdings.reduce((sum, h) => sum + h.weight, 0);
        values.push(sectorWeight);
        
        // Holdings within sector
        holdings.forEach(h => {
            labels.push(h.ticker);
            parents.push(sector);
            values.push(h.weight);
        });
    });
    
    const trace = {
        type: 'sunburst',
        labels: labels,
        parents: parents,
        values: values,
        branchvalues: 'total',
        marker: { colors: values.map((v, i) => i === 0 ? '#fff' : undefined) }
    };
    
    const layout = {
        title: 'Sector Allocation',
        paper_bgcolor: 'rgba(0,0,0,0)'
    };
    
    return { data: [trace], layout };
}

/**
 * Factor Exposure Bar Chart
 */
function createFactorExposureChart(data) {
    if (!data.factor_exposures) return;
    
    const fe = data.factor_exposures;
    
    const trace = {
        x: Object.keys(fe),
        y: Object.values(fe),
        type: 'bar',
        marker: {
            color: Object.values(fe).map(v => v > 0 ? '#22c55e' : '#ef4444')
        }
    };
    
    const layout = {
        title: 'Multi-Factor Exposures',
        xaxis: { title: 'Factor' },
        yaxis: { title: 'Exposure (z-score)' },
        shapes: [{
            type: 'line',
            x0: -0.5,
            x1: Object.keys(fe).length - 0.5,
            y0: 0,
            y1: 0,
            line: { color: '#000', width: 1 }
        }],
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    return { data: [trace], layout };
}

/**
 * Regime Detection Chart
 */
function createRegimeDetectionChart(data) {
    if (!data.regimes) return;
    
    const r = data.regimes;
    
    const traces = [
        {
            x: r.dates,
            y: r.returns,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#3b82f6', width: 1 },
            name: 'Returns'
        },
        {
            x: r.dates,
            y: r.regime_labels,
            type: 'scatter',
            mode: 'markers',
            marker: {
                color: r.regime_labels,
                colorscale: [[0, '#22c55e'], [0.5, '#f97316'], [1, '#ef4444']],
                size: 8
            },
            name: 'Regime',
            yaxis: 'y2'
        }
    ];
    
    const layout = {
        title: 'Market Regime Detection (HMM)',
        xaxis: { title: '' },
        yaxis: { title: 'Return', tickformat: '.1%' },
        yaxis2: {
            title: 'Regime',
            overlaying: 'y',
            side: 'right',
            tickmode: 'array',
            ticktext: ['Low Vol', 'Normal', 'High Vol'],
            tickvals: [0, 1, 2]
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
    };
    
    return { traces, layout };
}
</script>
{% endblock %}
