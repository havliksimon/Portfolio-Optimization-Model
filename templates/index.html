{% extends "base.html" %}

{% block title %}Institutional-Grade Portfolio Analytics{% endblock %}

{% block content %}

<!-- Hero Section -->
<div class="bg-gradient-to-r from-primary-600 to-cyan-600 rounded-2xl p-8 mb-8 text-white">
    <h1 class="text-4xl font-bold mb-4">Portfolio Optimization & Quantitative Analysis</h1>
    <p class="text-lg opacity-90 max-w-3xl">
        Institutional-grade quantitative analysis with Monte Carlo simulation, 
        distribution fitting, factor decomposition, and extreme value theory.
    </p>
    <div class="mt-6 flex flex-wrap gap-4">
        <a href="/upload" class="bg-white text-primary-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-100 transition shadow-lg">
            <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Portfolio
        </a>
        <a href="/analysis-comprehensive" class="bg-white/20 text-white px-6 py-3 rounded-xl font-semibold hover:bg-white/30 transition backdrop-blur-sm">
            <i class="fas fa-chart-area mr-2"></i>Advanced Analytics
        </a>
    </div>
</div>

<!-- Example Portfolio Card -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8 card-hover border border-slate-200">
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Example: Diversified Growth Portfolio</h2>
            <p class="text-slate-600">$100,000 portfolio across 15 holdings with auto-detected sectors</p>
        </div>
        <div class="flex gap-3">
            <a href="/auth/register" class="px-5 py-2.5 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700 transition flex items-center gap-2">
                <i class="fas fa-user-plus"></i> Register to Save
            </a>
            <button type="button" onclick="loadExamplePortfolio(); return false;" class="px-5 py-2.5 rounded-xl bg-primary-600 text-white font-medium hover:bg-primary-700 transition flex items-center gap-2">
                <i class="fas fa-play"></i> Edit & Analyze
            </button>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Holdings Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-50">
                    <tr class="border-b border-slate-200">
                        <th class="px-4 py-3 text-left font-medium text-slate-700">Ticker</th>
                        <th class="px-4 py-3 text-left font-medium text-slate-700">Company</th>
                        <th class="px-4 py-3 text-left font-medium text-slate-700">Sector</th>
                        <th class="px-4 py-3 text-right font-medium text-slate-700">Allocation</th>
                    </tr>
                </thead>
                <tbody class="text-slate-700">
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">AAPL</td>
                        <td class="px-4 py-3">Apple Inc</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">Technology</span></td>
                        <td class="px-4 py-3 text-right font-bold">12%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">MSFT</td>
                        <td class="px-4 py-3">Microsoft</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">Technology</span></td>
                        <td class="px-4 py-3 text-right font-bold">12%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">GOOGL</td>
                        <td class="px-4 py-3">Alphabet</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">Technology</span></td>
                        <td class="px-4 py-3 text-right font-bold">10%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">AMZN</td>
                        <td class="px-4 py-3">Amazon</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">Consumer</span></td>
                        <td class="px-4 py-3 text-right font-bold">8%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">NVDA</td>
                        <td class="px-4 py-3">NVIDIA</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">Technology</span></td>
                        <td class="px-4 py-3 text-right font-bold">7%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">JPM</td>
                        <td class="px-4 py-3">JPMorgan Chase</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Financials</span></td>
                        <td class="px-4 py-3 text-right font-bold">7%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">JNJ</td>
                        <td class="px-4 py-3">Johnson & Johnson</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Healthcare</span></td>
                        <td class="px-4 py-3 text-right font-bold">6%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">V</td>
                        <td class="px-4 py-3">Visa</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Financials</span></td>
                        <td class="px-4 py-3 text-right font-bold">6%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">PG</td>
                        <td class="px-4 py-3">Procter & Gamble</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-pink-100 text-pink-700 rounded text-xs">Consumer Staples</span></td>
                        <td class="px-4 py-3 text-right font-bold">5%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">UNH</td>
                        <td class="px-4 py-3">UnitedHealth</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Healthcare</span></td>
                        <td class="px-4 py-3 text-right font-bold">5%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">HD</td>
                        <td class="px-4 py-3">Home Depot</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">Consumer</span></td>
                        <td class="px-4 py-3 text-right font-bold">5%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">MA</td>
                        <td class="px-4 py-3">Mastercard</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Financials</span></td>
                        <td class="px-4 py-3 text-right font-bold">5%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">LLY</td>
                        <td class="px-4 py-3">Eli Lilly</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Healthcare</span></td>
                        <td class="px-4 py-3 text-right font-bold">5%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">KO</td>
                        <td class="px-4 py-3">Coca-Cola</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-pink-100 text-pink-700 rounded text-xs">Consumer Staples</span></td>
                        <td class="px-4 py-3 text-right font-bold">5%</td>
                    </tr>
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 font-semibold">PEP</td>
                        <td class="px-4 py-3">PepsiCo</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-pink-100 text-pink-700 rounded text-xs">Consumer Staples</span></td>
                        <td class="px-4 py-3 text-right font-bold">3%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Sector Allocation -->
        <div>
            <h3 class="text-lg font-semibold text-slate-900 mb-4">Sector Allocation</h3>
            <div id="chart-sector-allocation" class="h-64"></div>
            <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
                <div class="flex justify-between p-2 bg-slate-50 rounded">
                    <span class="text-slate-600">Technology</span>
                    <span class="font-semibold">41%</span>
                </div>
                <div class="flex justify-between p-2 bg-slate-50 rounded">
                    <span class="text-slate-600">Financials</span>
                    <span class="font-semibold">18%</span>
                </div>
                <div class="flex justify-between p-2 bg-slate-50 rounded">
                    <span class="text-slate-600">Healthcare</span>
                    <span class="font-semibold">16%</span>
                </div>
                <div class="flex justify-between p-2 bg-slate-50 rounded">
                    <span class="text-slate-600">Consumer</span>
                    <span class="font-semibold">13%</span>
                </div>
                <div class="flex justify-between p-2 bg-slate-50 rounded">
                    <span class="text-slate-600">Consumer Staples</span>
                    <span class="font-semibold">13%</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% if example_data %}
<!-- Pre-computed Analysis Dashboard -->
<div id="comprehensive-analysis" class="space-y-6 mb-8">

    <!-- Analysis Header -->
    <div class="gradient-bg rounded-2xl p-8 text-white">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <div>
                <h2 class="text-3xl font-bold mb-2">Quantitative Analysis Results</h2>
                <p class="text-lg opacity-90">{{ example_data.meta.name }}</p>
                <p class="text-sm opacity-75 mt-2">
                    <i class="fas fa-database mr-1"></i>Analysis computed: {{ example_data.meta.computed_at[:10] }} | 
                    <i class="fas fa-chart-line mr-1"></i>Period: {{ example_data.meta.period }} | 
                    <i class="fas fa-layer-group mr-1"></i>{{ example_data.meta.n_assets }} assets
                </p>
            </div>
            <div class="flex gap-3">
                <a href="/analysis-comprehensive" class="bg-white/20 text-white px-6 py-3 rounded-xl font-semibold hover:bg-white/30 transition backdrop-blur-sm">
                    <i class="fas fa-flask mr-2"></i>Run Custom Analysis
                </a>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">Ann. Return</p>
            <p class="text-xl font-bold text-green-600 mt-1">{{ "%.1f"|format(example_data.metrics.annualized_return * 100) }}%</p>
            <p class="text-xs text-slate-400">Geometric mean</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">Volatility</p>
            <p class="text-xl font-bold text-orange-600 mt-1">{{ "%.1f"|format(example_data.metrics.volatility * 100) }}%</p>
            <p class="text-xs text-slate-400">Annualized σ</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">Max Drawdown</p>
            <p class="text-xl font-bold text-red-600 mt-1">{{ "%.1f"|format(example_data.metrics.max_drawdown * 100) }}%</p>
            <p class="text-xs text-slate-400">{{ example_data.metrics.max_drawdown_duration }} days</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">Sharpe Ratio</p>
            <p class="text-xl font-bold text-blue-600 mt-1">{{ "%.2f"|format(example_data.metrics.sharpe_ratio) }}</p>
            <p class="text-xs text-slate-400">Risk-adjusted</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">Sortino</p>
            <p class="text-xl font-bold text-cyan-600 mt-1">{{ "%.2f"|format(example_data.metrics.sortino_ratio) }}</p>
            <p class="text-xs text-slate-400">Downside adj.</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">Beta</p>
            <p class="text-xl font-bold text-purple-600 mt-1">{{ "%.2f"|format(example_data.metrics.beta) }}</p>
            <p class="text-xs text-slate-400">vs S&P 500</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">Alpha</p>
            <p class="text-xl font-bold text-indigo-600 mt-1">{{ "%.1f"|format(example_data.metrics.alpha * 100) }}%</p>
            <p class="text-xs text-slate-400">Annualized</p>
        </div>
        <div class="bg-white rounded-xl p-4 card-shadow text-center border border-slate-200">
            <p class="text-xs text-slate-500 uppercase tracking-wide">CVaR (95%)</p>
            <p class="text-xl font-bold text-red-600 mt-1">{{ "%.1f"|format(example_data.metrics.cvar_95 * 100) }}%</p>
            <p class="text-xs text-slate-400">Expected Shortfall</p>
        </div>
    </div>

    <!-- Portfolio Holdings & Sector Allocation -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">
                <i class="fas fa-list text-primary-600 mr-2"></i>Portfolio Holdings
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-slate-700">Ticker</th>
                            <th class="px-3 py-2 text-left font-medium text-slate-700">Sector</th>
                            <th class="px-3 py-2 text-right font-medium text-slate-700">Weight</th>
                            <th class="px-3 py-2 text-right font-medium text-slate-700">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holding in example_data.holdings %}
                        <tr class="border-b border-slate-100">
                            <td class="px-3 py-2 font-semibold">{{ holding.ticker }}</td>
                            <td class="px-3 py-2">{{ holding.sector }}</td>
                            <td class="px-3 py-2 text-right">{{ "%.1f"|format(holding.weight * 100) }}%</td>
                            <td class="px-3 py-2 text-right">${{ "%.2f"|format(holding.price) if holding.price else '--' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">
                <i class="fas fa-chart-pie text-primary-600 mr-2"></i>Asset Allocation
            </h3>
            <div id="chart-allocation" class="h-64"></div>
        </div>
    </div>

    <!-- Return Distribution Analysis -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-chart-area text-primary-600 mr-2"></i>Return Distribution Analysis & Normality Tests
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div id="chart-return-distribution" class="h-80"></div>
            </div>
            <div class="space-y-3">
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm font-medium text-slate-700">Jarque-Bera Test</p>
                    <p class="text-xs text-slate-500">Normality</p>
                    <p class="text-2xl font-bold mt-1">{{ "%.2f"|format(example_data.statistical_tests.jarque_bera_stat) }}</p>
                    <p class="text-sm {{ 'text-green-600' if example_data.statistical_tests.is_normal else 'text-red-600' }}">
                        {{ 'Normal ✓' if example_data.statistical_tests.is_normal else 'Non-Normal ✗' }}
                    </p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm font-medium text-slate-700">Skewness</p>
                    <p class="text-xs text-slate-500">Asymmetry</p>
                    <p class="text-2xl font-bold mt-1">{{ "%.3f"|format(example_data.metrics.skewness) }}</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm font-medium text-slate-700">Kurtosis</p>
                    <p class="text-xs text-slate-500">Tail heaviness</p>
                    <p class="text-2xl font-bold mt-1">{{ "%.3f"|format(example_data.metrics.kurtosis) }}</p>
                </div>
            </div>
        </div>
        
        <!-- Distribution Fitting Table -->
        <div class="mt-6">
            <h4 class="text-sm font-medium text-slate-700 mb-2">Distribution Fitting (AIC Criteria)</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Distribution</th>
                            <th class="px-4 py-2 text-right">Mean</th>
                            <th class="px-4 py-2 text-right">Std Dev</th>
                            <th class="px-4 py-2 text-right">VaR 95%</th>
                            <th class="px-4 py-2 text-right">AIC</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if example_data.distributions_dict %}
                        {% for name, dist in example_data.distributions_dict.items() %}
                        {% if name != 'best_fit' %}
                        <tr class="border-b {{ 'bg-yellow-50' if name == example_data.distributions_dict.best_fit else '' }}">
                            <td class="px-4 py-2 font-medium {{ 'text-yellow-700' if name == example_data.distributions_dict.best_fit else '' }}">
                                {{ name }}
                                {% if name == example_data.distributions_dict.best_fit %}(Best){% endif %}
                            </td>
                            <td class="px-4 py-2 text-right">{{ "%.4f"|format(dist.mean) if dist.mean else '--' }}</td>
                            <td class="px-4 py-2 text-right">{{ "%.4f"|format(dist.std) if dist.std else '--' }}</td>
                            <td class="px-4 py-2 text-right">{{ "%.2f"|format(dist.var_95 * 100) if dist.var_95 else '--' }}%</td>
                            <td class="px-4 py-2 text-right text-gray-500">{{ "%.0f"|format(dist.aic) if dist.aic else '--' }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Non-normality warning -->
        {% if not example_data.statistical_tests.is_normal %}
        <div class="mt-4 p-4 bg-yellow-50 rounded-lg">
            <p class="text-sm text-yellow-800">
                <strong>Non-Normal Distribution Detected:</strong> 
                Returns follow a {{ example_data.distributions_dict.best_fit if example_data.distributions_dict else 'Student-t' }} distribution better than Normal.
                This indicates fat tails - extreme returns occur more frequently than a normal distribution would predict.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Monte Carlo Simulation -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-dice text-primary-600 mr-2"></i>Monte Carlo Simulation (5,000 Paths, 1 Year Horizon)
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div id="chart-monte-carlo" class="h-80"></div>
            </div>
            <div class="space-y-3">
                <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                    <p class="text-xs text-green-700">Probability of Profit</p>
                    <p class="text-2xl font-bold text-green-600">{{ "%.1f"|format(example_data.monte_carlo.probability_profit * 100) }}%</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                    <p class="text-xs text-blue-700">Mean Final Value</p>
                    <p class="text-xl font-bold text-blue-600">${{ "{:,.0f}".format(example_data.monte_carlo.mean_final) }}</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                    <p class="text-xs text-purple-700">Median Final Value</p>
                    <p class="text-xl font-bold text-purple-600">${{ "{:,.0f}".format(example_data.monte_carlo.median_final) }}</p>
                </div>
                <div class="bg-red-50 rounded-lg p-3 border border-red-200">
                    <p class="text-xs text-red-700">VaR 95% (1 Year)</p>
                    <p class="text-xl font-bold text-red-600">${{ "{:,.0f}".format(example_data.monte_carlo.var_95) }}</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                    <p class="text-xs text-slate-700">95% Confidence Interval</p>
                    <p class="text-sm font-bold text-slate-900">
                        {% if example_data.monte_carlo.confidence_interval_95 %}
                        ${{ "{:,.0f}".format(example_data.monte_carlo.confidence_interval_95[0]) }} - ${{ "{:,.0f}".format(example_data.monte_carlo.confidence_interval_95[1]) }}
                        {% else %}
                        --
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- VaR Analysis -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>Value at Risk (VaR) Analysis
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200">
                    <div>
                        <p class="text-sm text-red-700">Historical VaR (95%)</p>
                        <p class="text-xs text-red-500">Empirical percentile</p>
                    </div>
                    <p class="text-xl font-bold text-red-600">{{ "%.1f"|format(example_data.metrics.var_95 * 100) }}%</p>
                </div>
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200">
                    <div>
                        <p class="text-sm text-red-700">Historical VaR (99%)</p>
                        <p class="text-xs text-red-500">Extreme tail risk</p>
                    </div>
                    <p class="text-xl font-bold text-red-600">{{ "%.1f"|format(example_data.metrics.var_99 * 100) }}%</p>
                </div>
                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <div>
                        <p class="text-sm text-orange-700">CVaR / ES (95%)</p>
                        <p class="text-xs text-orange-500">Expected Shortfall</p>
                    </div>
                    <p class="text-xl font-bold text-orange-600">{{ "%.1f"|format(example_data.metrics.cvar_95 * 100) }}%</p>
                </div>
            </div>
        </div>

        <!-- Risk-Adjusted Metrics -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">
                <i class="fas fa-balance-scale text-primary-600 mr-2"></i>Risk-Adjusted Performance Metrics
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                    <p class="text-xs text-slate-500">Sortino Ratio</p>
                    <p class="text-2xl font-bold text-slate-900">{{ "%.2f"|format(example_data.metrics.sortino_ratio) }}</p>
                    <p class="text-xs text-slate-400">Downside risk</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                    <p class="text-xs text-slate-500">Calmar Ratio</p>
                    <p class="text-2xl font-bold text-slate-900">{{ "%.2f"|format(example_data.metrics.calmar_ratio) }}</p>
                    <p class="text-xs text-slate-400">Return / Max DD</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                    <p class="text-xs text-slate-500">Omega Ratio</p>
                    <p class="text-2xl font-bold text-slate-900">{{ "%.2f"|format(example_data.metrics.omega_ratio) }}</p>
                    <p class="text-xs text-slate-400">Gain/Loss ratio</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                    <p class="text-xs text-slate-500">Information Ratio</p>
                    <p class="text-2xl font-bold text-slate-900">{{ "%.2f"|format(example_data.metrics.information_ratio) }}</p>
                    <p class="text-xs text-slate-400">vs Benchmark</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawdown & Rolling Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">
                <i class="fas fa-arrow-down text-red-500 mr-2"></i>Drawdown Analysis
            </h3>
            <div id="chart-drawdown" class="h-80"></div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">
                <i class="fas fa-chart-line text-primary-600 mr-2"></i>Rolling Volatility (63-day)
            </h3>
            <div id="chart-rolling-vol" class="h-80"></div>
        </div>
    </div>

    <!-- Efficient Frontier -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-bullseye text-primary-600 mr-2"></i>Mean-Variance Optimization (Markowitz Efficient Frontier)
        </h3>
        <div id="chart-efficient-frontier" class="h-96"></div>
    </div>

    <!-- Performance Chart -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-chart-area text-primary-600 mr-2"></i>Portfolio Performance vs Benchmarks
        </h3>
        <div id="chart-performance" class="h-96"></div>
    </div>

    <!-- Risk Contribution -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-chart-pie text-primary-600 mr-2"></i>Risk Contribution Analysis
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div id="chart-risk-contribution" class="h-80"></div>
            <div class="space-y-4">
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm text-slate-500">Effective N (Diversification)</p>
                    <p class="text-3xl font-bold text-primary-600">{{ "%.1f"|format(example_data.metrics.effective_n) }}</p>
                    <p class="text-xs text-slate-400">Uncorrelated bets</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm text-slate-500">Concentration (HHI)</p>
                    <p class="text-3xl font-bold text-orange-600">{{ "%.1f"|format(example_data.metrics.concentration * 100) }}%</p>
                    <p class="text-xs text-slate-400">Lower is better</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm text-slate-500">Diversification Ratio</p>
                    <p class="text-3xl font-bold text-blue-600">{{ "%.2f"|format(example_data.metrics.diversification_ratio) }}</p>
                    <p class="text-xs text-slate-400">Portfolio vs weighted avg</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rolling Statistics with Confidence Bands -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-chart-line text-primary-600 mr-2"></i>Rolling Statistics (63-day) with 95% Confidence Bands
        </h3>
        <div id="chart-rolling-stats" class="h-80"></div>
    </div>

    <!-- Rolling Beta -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-wave-square text-primary-600 mr-2"></i>Rolling Beta (63-day)
        </h3>
        <div id="chart-rolling-beta" class="h-80"></div>
    </div>

    <!-- Volatility Analysis -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-wave-square text-primary-600 mr-2"></i>Volatility Clustering (ARCH Effects)
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div>
                <div id="chart-volatility" class="h-64"></div>
            </div>
            <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm text-slate-500">Volatility of Volatility</p>
                    <p class="text-2xl font-bold text-slate-900">{{ "%.1f"|format(example_data.metrics.vol_of_vol * 100) if example_data.metrics.vol_of_vol else '--' }}%</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm text-slate-500">Volatility Persistence</p>
                    <p class="text-2xl font-bold text-slate-900">{{ "%.3f"|format(example_data.metrics.vol_persistence) if example_data.metrics.vol_persistence else '--' }}</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm text-slate-500">Half-Life (days)</p>
                    <p class="text-2xl font-bold text-slate-900">{{ "%.1f"|format(example_data.metrics.half_life) if example_data.metrics.half_life else '--' }}</p>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <p class="text-sm text-slate-500">ARCH Effects</p>
                    <p class="text-2xl font-bold {{ 'text-orange-600' if example_data.metrics.has_arch_effects else 'text-green-600' }}">
                        {{ 'DETECTED' if example_data.metrics.has_arch_effects else 'NONE' }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Principal Component Analysis -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-project-diagram text-primary-600 mr-2"></i>Principal Component Analysis (PCA)
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h4 class="text-sm font-medium text-slate-700 mb-2">Explained Variance</h4>
                <div id="chart-pca-variance" class="h-64"></div>
            </div>
            <div>
                <h4 class="text-sm font-medium text-slate-700 mb-2">Factor Loadings (PC1, PC2, PC3)</h4>
                <div id="chart-pca-loadings" class="h-64"></div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                        <p class="text-xs text-slate-500">Condition Number</p>
                        <p class="text-lg font-bold text-slate-900">{{ "%.1f"|format(example_data.metrics.pca_condition) if example_data.metrics.pca_condition else '--' }}</p>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                        <p class="text-xs text-slate-500">Effective Rank</p>
                        <p class="text-lg font-bold text-slate-900">{{ "%.1f"|format(example_data.metrics.pca_rank) if example_data.metrics.pca_rank else '--' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rolling Correlation -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-link text-primary-600 mr-2"></i>Rolling Correlation Analysis
        </h3>
        <div id="chart-rolling-correlation" class="h-80"></div>
    </div>

    <!-- Monthly Returns Heatmap -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-th text-primary-600 mr-2"></i>Monthly Returns Heatmap
        </h3>
        <div id="chart-monthly-returns" class="h-96"></div>
    </div>

    <!-- Factor Exposure -->
    {% if example_data.factor_exposure %}
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-layer-group text-primary-600 mr-2"></i>Factor Exposure Analysis (Fama-French 5-Factor Model)
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Market (β)</p>
                <p class="text-2xl font-bold text-primary-600">{{ "%.2f"|format(example_data.metrics.beta) }}</p>
                <p class="text-xs text-slate-400">Systematic risk</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Size (SMB)</p>
                <p class="text-2xl font-bold text-blue-600">{{ "%.3f"|format(example_data.factor_exposure.smb_beta) }}</p>
                <p class="text-xs text-slate-400">Small cap premium</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Value (HML)</p>
                <p class="text-2xl font-bold text-emerald-600">{{ "%.3f"|format(example_data.factor_exposure.hml_beta) }}</p>
                <p class="text-xs text-slate-400">Value premium</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Alpha (α)</p>
                <p class="text-2xl font-bold text-purple-600">{{ "%.2f"|format(example_data.factor_exposure.alpha * 100) }}%</p>
                <p class="text-xs text-slate-400">Excess return</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 text-center border border-slate-200">
                <p class="text-xs text-slate-500">R²</p>
                <p class="text-2xl font-bold text-orange-600">{{ "%.1f"|format(example_data.metrics.r_squared * 100) }}%</p>
                <p class="text-xs text-slate-400">Model fit</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Advanced Risk Metrics -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-shield-alt text-primary-600 mr-2"></i>Advanced Risk Metrics
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Modified VaR (95%)</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.1f"|format(example_data.advanced_risk.mvar_95 * 100) }}%</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Modified VaR (99%)</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.1f"|format(example_data.advanced_risk.mvar_99 * 100) }}%</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Ulcer Index</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.3f"|format(example_data.advanced_risk.ulcer_index) }}</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Pain Ratio</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.2f"|format(example_data.advanced_risk.pain_ratio) }}</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Tail Ratio (95/5)</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.2f"|format(example_data.advanced_risk.tail_ratio_95_5) }}</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Kappa-3</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.2f"|format(example_data.advanced_risk.kappa_3) }}</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Kelly Fraction</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.2f"|format(example_data.advanced_risk.kelly_fraction) }}</p>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                <p class="text-xs text-slate-500">Half-Kelly</p>
                <p class="text-lg font-bold text-slate-700">{{ "%.2f"|format(example_data.advanced_risk.half_kelly_fraction) }}</p>
            </div>
        </div>
    </div>

    <!-- Risk Matrix -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-exclamation-circle text-primary-600 mr-2"></i>Risk Matrix
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-slate-700">Risk Factor</th>
                        <th class="px-4 py-3 text-right font-medium text-slate-700">Value</th>
                        <th class="px-4 py-3 text-center font-medium text-slate-700">Risk Level</th>
                        <th class="px-4 py-3 text-left font-medium text-slate-700">Interpretation</th>
                    </tr>
                </thead>
                <tbody id="risk-matrix-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Stress Test Scenarios -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>Stress Test Scenarios
        </h3>
        <div id="stress-test-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        </div>
    </div>

    <!-- AI Quantitative Analysis Report -->
    <div class="bg-gradient-to-r from-primary-50 to-indigo-50 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-brain text-primary-600 mr-2"></i>AI Quantitative Analysis Report
        </h3>
        <div id="ai-content" class="space-y-4">
        </div>
    </div>

    <!-- Correlation Matrix Heatmap -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">
            <i class="fas fa-th text-primary-600 mr-2"></i>Asset Correlation Matrix
        </h3>
        <div id="correlation-heatmap" class="h-80"></div>
    </div>

    <!-- Call to Action -->
    <div class="bg-gradient-to-r from-primary-600 to-blue-600 rounded-xl p-6 text-white text-center">
        <h3 class="text-xl font-bold mb-2">Want to analyze your own portfolio?</h3>
        <p class="mb-4 opacity-90">Register for free to save portfolios, run custom analyses, and access all features.</p>
        <div class="flex justify-center gap-4">
            <a href="/auth/register" class="bg-white text-primary-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-100 transition shadow-lg">
                <i class="fas fa-user-plus mr-2"></i>Register Free
            </a>
            <a href="/auth/login" class="bg-white/20 text-white px-6 py-3 rounded-xl font-semibold hover:bg-white/30 transition">
                <i class="fas fa-sign-in-alt mr-2"></i>Login
            </a>
        </div>
    </div>

</div>
{% endif %}

<!-- Portfolio Builder -->
<div id="portfolio-builder" class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-slate-200">
    <h2 class="text-2xl font-bold text-slate-900 mb-4">Portfolio Builder & Analysis</h2>
    <p class="text-slate-600 mb-6">Build your portfolio and run comprehensive quantitative analysis</p>
    
    <form id="portfolio-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Total Portfolio Value</label>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-500">$</span>
                    <input type="number" id="portfolio-value" class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent" value="100000" min="1000" step="1000">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Analysis Period</label>
                <select id="period-select" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <option value="1y">1 Year</option>
                    <option value="2y" selected>2 Years</option>
                    <option value="5y">5 Years</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full bg-primary-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-primary-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-chart-line"></i>
                    <span>Run Full Analysis</span>
                </button>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Render all charts when page loads
document.addEventListener('DOMContentLoaded', () => {
    {% if example_data and example_data.charts %}
    renderAllCharts({{ example_data | tojson | safe }});
    {% endif %}
});

function renderAllCharts(data) {
    const charts = data.charts;
    
    // Sector Allocation Pie
    if (charts.allocation && charts.allocation.pie) {
        Plotly.newPlot('chart-sector-allocation', [{
            values: charts.allocation.pie.values,
            labels: charts.allocation.pie.labels,
            type: 'pie',
            hole: 0.4,
            marker: { colors: ['#3b82f6', '#06b6d4', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b'] }
        }], {
            margin: { t: 10, r: 10, b: 10, l: 10 },
            showlegend: true,
            legend: { orientation: 'h', y: -0.1 }
        }, {displayModeBar: false});
    }
    
    // Asset Allocation
    if (charts.allocation && charts.allocation.pie) {
        Plotly.newPlot('chart-allocation', [{
            values: charts.allocation.pie.values,
            labels: charts.allocation.pie.labels,
            type: 'pie',
            marker: { colors: ['#3b82f6', '#06b6d4', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b', '#6366f1', '#14b8a6'] }
        }], {
            margin: { t: 10, r: 10, b: 10, l: 10 },
            showlegend: true
        }, {displayModeBar: false});
    }
    
    // Return Distribution
    if (charts.return_distribution) {
        const traces = [];
        if (charts.return_distribution.kde) {
            traces.push({
                x: charts.return_distribution.kde.x,
                y: charts.return_distribution.kde.y,
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                fillcolor: 'rgba(59, 130, 246, 0.2)',
                line: { color: '#3b82f6', width: 2 },
                name: 'Return Distribution'
            });
        }
        Plotly.newPlot('chart-return-distribution', traces, {
            margin: { t: 20, r: 20, b: 40, l: 60 },
            xaxis: { title: 'Daily Return', tickformat: '.2%' },
            yaxis: { title: 'Density' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        }, {displayModeBar: false});
    }
    
    // Monte Carlo
    if (charts.monte_carlo && charts.monte_carlo.percentiles) {
        const mc = charts.monte_carlo;
        const traces = [];
        
        // Sample paths
        if (mc.paths) {
            mc.paths.forEach((path, i) => {
                if (i % 5 === 0) {
                    traces.push({
                        x: mc.days,
                        y: path,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: 'rgba(150,150,150,0.1)', width: 1 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                }
            });
        }
        
        // Fill bands
        if (mc.percentiles.p95 && mc.percentiles.p5) {
            traces.push({
                x: mc.days.concat([...mc.days].reverse()),
                y: mc.percentiles.p95.concat([...mc.percentiles.p5].reverse()),
                fill: 'toself',
                fillcolor: 'rgba(59,130,246,0.1)',
                line: { color: 'transparent' },
                name: '90% CI',
                hoverinfo: 'skip'
            });
        }
        
        // Median
        if (mc.percentiles.p50) {
            traces.push({
                x: mc.days,
                y: mc.percentiles.p50,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#3b82f6', width: 3 },
                name: 'Median'
            });
        }
        
        Plotly.newPlot('chart-monte-carlo', traces, {
            margin: { t: 20, r: 20, b: 40, l: 70 },
            xaxis: { title: 'Days' },
            yaxis: { title: 'Portfolio Value ($)', tickformat: '$,.0f' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true
        }, {displayModeBar: false});
    }
    
    // Drawdown
    if (charts.drawdown) {
        Plotly.newPlot('chart-drawdown', [{
            x: charts.drawdown.dates,
            y: charts.drawdown.drawdown,
            type: 'scatter',
            mode: 'lines',
            fill: 'tozeroy',
            fillcolor: 'rgba(239, 68, 68, 0.2)',
            line: { color: '#ef4444', width: 1 },
            name: 'Drawdown'
        }], {
            margin: { t: 20, r: 20, b: 40, l: 60 },
            xaxis: { title: 'Date' },
            yaxis: { title: 'Drawdown', tickformat: '.0%' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        }, {displayModeBar: false});
    }
    
    // Rolling Volatility
    if (charts.rolling_metrics && charts.rolling_metrics['60d']) {
        const rm = charts.rolling_metrics['60d'];
        Plotly.newPlot('chart-rolling-vol', [{
            x: rm.dates,
            y: rm.volatility,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#f59e0b', width: 2 },
            name: 'Volatility'
        }], {
            margin: { t: 20, r: 20, b: 40, l: 60 },
            xaxis: { title: 'Date' },
            yaxis: { title: 'Annualized Volatility', tickformat: '.0%' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        }, {displayModeBar: false});
    }
    
    // Efficient Frontier
    if (charts.efficient_frontier) {
        const ef = charts.efficient_frontier;
        const traces = [];
        
        // Random portfolios
        if (ef.random_portfolios) {
            traces.push({
                x: ef.random_portfolios.volatility,
                y: ef.random_portfolios.returns,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    color: ef.random_portfolios.sharpe,
                    colorscale: 'Viridis',
                    size: 5,
                    opacity: 0.6
                },
                name: 'Random Portfolios'
            });
        }
        
        // Current portfolio
        if (ef.current_portfolio) {
            traces.push({
                x: [ef.current_portfolio.volatility],
                y: [ef.current_portfolio.return],
                mode: 'markers',
                marker: { color: '#ef4444', size: 15, symbol: 'star' },
                name: 'Your Portfolio'
            });
        }
        
        // Frontier
        if (ef.frontier) {
            traces.push({
                x: ef.frontier.map(p => p.volatility),
                y: ef.frontier.map(p => p.return_annualized),
                mode: 'lines',
                line: { color: '#8b5cf6', width: 3 },
                name: 'Efficient Frontier'
            });
        }
        
        Plotly.newPlot('chart-efficient-frontier', traces, {
            margin: { t: 20, r: 80, b: 40, l: 60 },
            xaxis: { title: 'Volatility', tickformat: '.1%' },
            yaxis: { title: 'Expected Return', tickformat: '.1%' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true
        }, {displayModeBar: false});
    }
    
    // Performance
    if (charts.performance && charts.performance.portfolio) {
        const traces = [{
            x: charts.performance.portfolio.dates,
            y: charts.performance.portfolio.values,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#2563eb', width: 2 },
            name: 'Portfolio'
        }];
        
        if (charts.performance.benchmarks) {
            Object.keys(charts.performance.benchmarks).forEach((bm, i) => {
                if (charts.performance.benchmarks[bm]) {
                    traces.push({
                        x: charts.performance.benchmarks[bm].dates,
                        y: charts.performance.benchmarks[bm].values,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: ['#ef4444', '#10b981'][i] || '#f59e0b', width: 1.5 },
                        name: bm
                    });
                }
            });
        }
        
        Plotly.newPlot('chart-performance', traces, {
            margin: { t: 20, r: 20, b: 40, l: 60 },
            xaxis: { title: 'Date' },
            yaxis: { title: 'Cumulative Return', tickformat: '.0%' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true
        }, {displayModeBar: false});
    }
    
    // Risk Contribution
    if (charts.risk_contribution) {
        Plotly.newPlot('chart-risk-contribution', [{
            x: charts.risk_contribution.tickers,
            y: charts.risk_contribution.risk_contrib_pct,
            type: 'bar',
            marker: { color: '#3b82f6' }
        }], {
            margin: { t: 20, r: 20, b: 60, l: 60 },
            xaxis: { title: '', tickangle: -45 },
            yaxis: { title: 'Risk Contribution (%)' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        }, {displayModeBar: false});
    }
    
    // Monthly Returns Heatmap
    if (charts.monthly_returns && charts.monthly_returns.data) {
        const mr = charts.monthly_returns;
        Plotly.newPlot('chart-monthly-returns', [{
            z: mr.data,
            x: mr.months || ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
            y: mr.years.map(String),
            type: 'heatmap',
            colorscale: [
                [0, '#dc2626'],
                [0.25, '#fca5a5'],
                [0.5, '#ffffff'],
                [0.75, '#86efac'],
                [1, '#16a34a']
            ],
            zmid: 0,
            text: mr.data.map(row => row.map(v => v !== null ? (v * 100).toFixed(1) + '%' : '')),
            texttemplate: '%{text}',
            textfont: { size: 10 },
            hovertemplate: '%{y} %{x}: %{z:.1%}<extra></extra>'
        }], {
            margin: { t: 40, r: 20, b: 40, l: 50 },
            xaxis: { title: '' },
            yaxis: { title: '', autorange: 'reversed' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        }, {displayModeBar: false});
    }
    
    // Rolling Statistics with Confidence Bands
    if (charts.rolling_stats_63d && charts.rolling_stats_63d.dates) {
        const rs = charts.rolling_stats_63d;
        const traces = [
            {
                x: rs.dates,
                y: rs.mean_upper,
                type: 'scatter',
                mode: 'lines',
                line: { color: 'transparent' },
                showlegend: false,
                hoverinfo: 'skip'
            },
            {
                x: rs.dates,
                y: rs.mean_lower,
                type: 'scatter',
                mode: 'lines',
                fill: 'tonexty',
                fillcolor: 'rgba(59,130,246,0.15)',
                line: { color: 'transparent' },
                name: '95% CI',
                hoverinfo: 'skip'
            },
            {
                x: rs.dates,
                y: rs.mean,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#3b82f6', width: 2 },
                name: 'Rolling Mean'
            },
            {
                x: rs.dates,
                y: rs.std,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#f97316', width: 2, dash: 'dash' },
                name: 'Volatility',
                yaxis: 'y2'
            }
        ];
        
        Plotly.newPlot('chart-rolling-stats', traces, {
            margin: { t: 20, r: 60, b: 40, l: 60 },
            xaxis: { title: 'Date' },
            yaxis: { title: 'Annualized Return', tickformat: '.1%' },
            yaxis2: { title: 'Volatility', overlaying: 'y', side: 'right', tickformat: '.1%' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true
        }, {displayModeBar: false});
    }
    
    // Rolling Beta
    if (charts.rolling_metrics && charts.rolling_metrics['60d'] && charts.rolling_metrics['60d'].beta) {
        const rm = charts.rolling_metrics['60d'];
        Plotly.newPlot('chart-rolling-beta', [{
            x: rm.dates,
            y: rm.beta,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#8b5cf6', width: 2 },
            name: 'Beta'
        }], {
            margin: { t: 20, r: 20, b: 40, l: 60 },
            xaxis: { title: 'Date' },
            yaxis: { title: 'Beta', rangemode: 'tozero' },
            shapes: [{
                type: 'line',
                x0: rm.dates[0],
                x1: rm.dates[rm.dates.length - 1],
                y0: 1,
                y1: 1,
                line: { color: 'gray', dash: 'dash' }
            }],
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        }, {displayModeBar: false});
    }
    
    // Volatility Chart
    if (charts.volatility && charts.volatility.dates) {
        Plotly.newPlot('chart-volatility', [{
            x: charts.volatility.dates,
            y: charts.volatility.returns,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#3b82f6', width: 1 },
            name: 'Returns'
        }], {
            margin: { t: 20, r: 20, b: 40, l: 60 },
            xaxis: { title: 'Date' },
            yaxis: { title: 'Daily Return', tickformat: '.1%' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        }, {displayModeBar: false});
    }
    
    // PCA Variance Chart
    if (charts.pca && charts.pca.explained_variance) {
        const labels = charts.pca.explained_variance.map((_, i) => `PC${i+1}`);
        Plotly.newPlot('chart-pca-variance', [
            {
                x: labels,
                y: charts.pca.explained_variance,
                type: 'bar',
                name: 'Individual',
                marker: { color: '#3b82f6' }
            },
            {
                x: labels,
                y: charts.pca.cumulative_variance,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Cumulative',
                line: { color: '#f97316', width: 2 },
                yaxis: 'y2'
            }
        ], {
            margin: { t: 20, r: 60, b: 40, l: 60 },
            xaxis: { title: 'Principal Component' },
            yaxis: { title: 'Variance Explained', tickformat: '.1%' },
            yaxis2: { title: 'Cumulative', overlaying: 'y', side: 'right', tickformat: '.1%', range: [0, 1.1] },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true
        }, {displayModeBar: false});
    }
    
    // PCA Loadings Chart
    if (charts.pca && charts.pca.loadings && charts.pca.tickers) {
        const pca = charts.pca;
        const loadings = pca.loadings;
        const traces = [];
        const colors = ['#3b82f6', '#f97316', '#22c55e'];
        
        for (let i = 0; i < Math.min(3, loadings[0]?.length || 0); i++) {
            traces.push({
                x: pca.tickers,
                y: loadings.map(row => row[i]),
                type: 'bar',
                name: `PC${i+1}`,
                marker: { color: colors[i] }
            });
        }
        
        Plotly.newPlot('chart-pca-loadings', traces, {
            margin: { t: 20, r: 20, b: 80, l: 60 },
            xaxis: { title: '', tickangle: -45 },
            yaxis: { title: 'Loading' },
            barmode: 'group',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true
        }, {displayModeBar: false});
    }
    
    // Rolling Correlation (top 5 pairs only)
    if (charts.rolling_correlation && charts.rolling_correlation.dates) {
        const rc = charts.rolling_correlation;
        
        if (rc.correlations && rc.dates) {
            const traces = Object.entries(rc.correlations).slice(0, 5).map(([pairName, values], i) => ({
                x: rc.dates,
                y: values,
                type: 'scatter',
                mode: 'lines',
                name: pairName,
                line: { width: 1.5 },
                opacity: 0.8
            }));
            
            // Add horizontal line at 0
            traces.push({
                x: [rc.dates[0], rc.dates[rc.dates.length - 1]],
                y: [0, 0],
                type: 'scatter',
                mode: 'lines',
                line: { color: '#94a3b8', width: 1, dash: 'dash' },
                showlegend: false,
                hoverinfo: 'skip'
            });
            
            Plotly.newPlot('chart-rolling-correlation', traces, {
                title: { text: '90-Day Rolling Pairwise Correlations', font: { size: 14 } },
                xaxis: { title: '', gridcolor: '#f0f0f0' },
                yaxis: { title: 'Correlation', range: [-1, 1], gridcolor: '#f0f0f0' },
                showlegend: true,
                legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 40, r: 20, b: 40, l: 60 }
            }, {displayModeBar: false});
        }
    }
    
    // Correlation Matrix Heatmap
    if (data.correlation_matrix) {
        const tickers = Object.keys(data.correlation_matrix);
        const matrix = tickers.map(t1 => tickers.map(t2 => data.correlation_matrix[t1][t2]));
        
        const trace = {
            z: matrix,
            x: tickers,
            y: tickers,
            type: 'heatmap',
            colorscale: [[0, '#3b82f6'], [0.5, '#ffffff'], [1, '#ef4444']],
            zmid: 0,
            zmin: -1,
            zmax: 1,
            text: matrix.map(row => row.map(v => v.toFixed(2))),
            texttemplate: '%{text}',
            textfont: { size: 10 }
        };
        
        Plotly.newPlot('correlation-heatmap', [trace], {
            margin: { t: 20, r: 20, b: 60, l: 80 }
        }, {displayModeBar: false});
    }
    
    // Stress Test Grid
    if (data.stress_test) {
        const grid = document.getElementById('stress-test-grid');
        if (grid) {
            grid.innerHTML = '';
            Object.entries(data.stress_test).forEach(([scenario, impact]) => {
                const div = document.createElement('div');
                div.className = 'bg-red-50 rounded-lg p-4 text-center';
                div.innerHTML = `
                    <p class="text-sm text-red-700 font-medium">${scenario}</p>
                    <p class="text-2xl font-bold text-red-600 mt-1">${(impact * 100).toFixed(1)}%</p>
                `;
                grid.appendChild(div);
            });
        }
    }
    
    // AI Insights
    if (data.ai_insights) {
        const container = document.getElementById('ai-content');
        if (container) {
            const insights = data.ai_insights;
            let html = '<div class="space-y-4">';
            
            if (insights.risk_assessment) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <h4 class="font-semibold text-gray-900 mb-2">
                            <i class="fas fa-shield-alt text-red-500 mr-2"></i>Risk Assessment
                        </h4>
                        <p class="text-gray-700 text-sm leading-relaxed">${insights.risk_assessment}</p>
                    </div>
                `;
            }
            
            if (insights.factor_analysis) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <h4 class="font-semibold text-gray-900 mb-2">
                            <i class="fas fa-project-diagram text-blue-500 mr-2"></i>Factor Analysis
                        </h4>
                        <p class="text-gray-700 text-sm leading-relaxed">${insights.factor_analysis}</p>
                    </div>
                `;
            }
            
            if (insights.recommendation) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <h4 class="font-semibold text-gray-900 mb-2">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Recommendations
                        </h4>
                        <p class="text-gray-700 text-sm leading-relaxed">${insights.recommendation}</p>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
    }
    
    // Risk Matrix Table
    if (data.metrics) {
        const m = data.metrics;
        const tbody = document.getElementById('risk-matrix-tbody');
        if (tbody) {
            const risks = [
                { 
                    factor: 'Volatility', 
                    value: m.volatility, 
                    levels: [{ max: 0.15, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.25, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
                    interpretation: 'Annualized standard deviation of returns'
                },
                { 
                    factor: 'Maximum Drawdown', 
                    value: Math.abs(m.max_drawdown), 
                    levels: [{ max: 0.15, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.25, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
                    interpretation: 'Largest peak-to-trough decline'
                },
                { 
                    factor: 'VaR (95%)', 
                    value: Math.abs(m.var_95), 
                    levels: [{ max: 0.02, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.035, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
                    interpretation: 'Daily loss not exceeded 95% of the time'
                },
                { 
                    factor: 'CVaR (95%)', 
                    value: Math.abs(m.cvar_95), 
                    levels: [{ max: 0.025, level: 'Low', color: 'bg-green-100 text-green-800' }, { max: 0.045, level: 'Medium', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'High', color: 'bg-red-100 text-red-800' }],
                    interpretation: 'Expected loss given VaR is exceeded'
                },
                { 
                    factor: 'Beta', 
                    value: m.beta, 
                    levels: [{ max: 0.8, level: 'Defensive', color: 'bg-blue-100 text-blue-800' }, { max: 1.1, level: 'Neutral', color: 'bg-green-100 text-green-800' }, { max: 10, level: 'Aggressive', color: 'bg-orange-100 text-orange-800' }],
                    interpretation: 'Sensitivity to market movements'
                },
                { 
                    factor: 'Concentration (HHI)', 
                    value: m.concentration, 
                    levels: [{ max: 0.15, level: 'Diversified', color: 'bg-green-100 text-green-800' }, { max: 0.25, level: 'Moderate', color: 'bg-yellow-100 text-yellow-800' }, { max: 1, level: 'Concentrated', color: 'bg-red-100 text-red-800' }],
                    interpretation: 'Portfolio concentration risk'
                }
            ];
            
            tbody.innerHTML = risks.map(risk => {
                const level = risk.levels.find(l => risk.value <= l.max) || risk.levels[risk.levels.length - 1];
                const formatted = (risk.value * 100).toFixed(2) + '%';
                
                return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="px-4 py-3 font-medium">${risk.factor}</td>
                        <td class="px-4 py-3 text-right">${formatted}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded text-xs font-medium ${level.color}">${level.level}</span>
                        </td>
                        <td class="px-4 py-3 text-slate-500">${risk.interpretation}</td>
                    </tr>
                `;
            }).join('');
        }
    }
}

// Portfolio builder form
document.getElementById('portfolio-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    window.location.href = '/analysis-comprehensive';
});

function loadExamplePortfolio() {
    window.location.href = '/analysis-comprehensive';
}
</script>
{% endblock %}
